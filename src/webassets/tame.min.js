/*************************************************************************
 * TAME Engine v0.9BETA18
 * (C) 2016-2019 Matthew Tropiano
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the GNU Lesser Public License v2.1
 * which accompanies this distribution, and is available at
 * http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html
 * 
 * https://tame-if.com
 * @license
 *************************************************************************/
let TAME=function(e){this.version="0.9BETA18";var t,n={};n.nanoTime=null,n.each=function(e,t){for(let n in e)e.hasOwnProperty(n)&&t(e[n],n,e.length)},n.format=function(){if(!arguments.length)return null;let e=arguments[0],t=Array.prototype.slice.call(arguments,1);for(let n in t)e=e.replace(new RegExp("\\{"+n+"\\}","gi"),t[n]);return e},n.strcmp=function(e,t){let n=e.length,a=t.length,r=Math.min(n,a),i=0;for(;i<r;){let n=e.charCodeAt(i),a=t.charCodeAt(i);if(n!=a)return n-a;i++}return n-a},n.arrayRemove=function(e,t){for(let n=0;n<e.length;n++)if(e[n]==t)return e.splice(n,1),!0;return!1},n.objectStringAdd=function(e,t,n){let a=e[t];a||(a=e[t]={}),a[n]||(a[n]=!0)},n.objectStringRemove=function(e,t,n){let a=e[t];a&&a[n]&&delete a[n]},n.objectStringContains=function(e,t,n){let a=e[t];return a&&a[n]},n.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},n.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},n.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},n.mapify=function(e,t,a){let r={};for(let i in e)if(e.hasOwnProperty(i)){let o=r[e[i][t]];a&&o?n.isArray(o)?o.push(e[i]):r[e[i][t]]=[r[e[i][t]],e[i]]:r[e[i][t]]=e[i]}return r},n.pairify=function(e,t,a,r){let i={};for(let o in e)if(e.hasOwnProperty(o)){let l=i[e[o][t]];r&&l?n.isArray(l)?l.push(e[o][a]):i[e[o][t]]=[i[e[o][t]],e[o][a]]:i[e[o][t]]=e[o][a]}return i},n.replaceAll=function(e,t,n){return e.replace(new RegExp(t,"g"),n)},n.withEscChars=function(e){let t=JSON.stringify(e);return t.substring(1,t.length-1)},n.formatDate=function(e,t){let n={dayInWeek:[["S","M","T","W","T","F","S"],["Su","Mo","Tu","We","Th","Fr","Sa"],["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]],monthInYear:[["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],["January","February","March","April","May","June","July","August","September","October","November","December"]]},a=function(e,t){e=parseInt(e,10);let n="";do{n=e%10+n,e=Math.floor(e/10),t--}while(e>0);for(;t-- >0;)n="0"+n;return n},r=/e+|E+|y+|M+|d+|w+|W+|a+|A+|h+|H+|k+|K+|m+|s+|S+|z+|Z+|X+|'.*'/g,i={e:function(e,t,n){return n.getFullYear()<0?t.length<2?"b":"bc":t.length<2?"a":"ad"},E:function(e,t,n){return n.getFullYear()<0?t.length<2?"B":"BC":t.length<2?"A":"AD"},y:function(e,t,n){return a(n.getFullYear(),t.length)},M:function(e,t,n){if(t.length<=2)return a(n.getMonth()+1,t.length);{let a=n.getMonth(),r=Math.min(Math.max(t.length-3,0),1);return e.monthInYear[r][a]}},d:function(e,t,n){return a(n.getDate(),t.length)},W:function(e,t,n){let a=Math.min(Math.max(t.length-1,0),3),r=n.getDay();return e.dayInWeek[a][r]},w:function(e,t,n){return a(n.getDay(),t.length)},a:function(e,t,n){return n.getHours()<12?t.length<2?"a":"am":t.length<2?"p":"pm"},A:function(e,t,n){return n.getHours()<12?t.length<2?"A":"AM":t.length<2?"P":"PM"},h:function(e,t,n){return a(n.getHours(),t.length)},H:function(e,t,n){return a(n.getHours()+1,t.length)},k:function(e,t,n){return a(n.getHours()%12,t.length)},K:function(e,t,n){return a(n.getHours()%12+1,t.length)},m:function(e,t,n){return a(n.getMinutes(),t.length)},s:function(e,t,n){return a(n.getSeconds(),t.length)},S:function(e,t,n){return a(n.getMilliseconds(),t.length)},z:function(e,t,n){let r=n.getTimezoneOffset(),i=Math.abs(n.getTimezoneOffset());return"GMT"+(r>0?"-":"+")+a(i/60,2)+":"+a(i%60,2)},Z:function(e,t,n){let r=n.getTimezoneOffset(),i=Math.abs(n.getTimezoneOffset());return(r>0?"-":"+")+a(i/60,2)+a(i%60,2)},X:function(e,t,n){let r=n.getTimezoneOffset(),i=Math.abs(n.getTimezoneOffset());switch(t.length){case 1:return(r>0?"-":"+")+i/60;case 2:return(r>0?"-":"+")+a(i/60,2);case 3:return(r>0?"-":"+")+a(i/60,2)+a(i%60,2);case 4:return(r>0?"-":"+")+a(i/60,2)+":"+a(i%60,2);default:return"GMT"+(r>0?"-":"+")+a(i/60,2)+":"+a(i%60,2)}},"'":function(e,t,n){return 2==t.length?"'":t.substring(1,t.length-1)}};e=new Date(e);let o,l=0,c="";for(;o=r.exec(t);){let a=o[0],u=o.index;u>l&&(c+=t.substring(l,u)),c+=i[a[0]](n,a,e),l=r.lastIndex}return l<t.length&&(c+=t.substring(l)),c},n.parseFormatted=function(e,t,n,a){let r="",i=[],o=[],l=function(){if(0===r.length)return;let e=[];a(r,e),o.push.apply(o,e),r=""},c=function(){if(0===r.length)return;let e=r;if(r="","/"==e){if(0===i.length)return;let e=[];n(i.pop(),e),o.push.apply(o,e)}else{i.push(e);let n=[];t(e,n),o.push.apply(o,n)}},u=0,s=e.length,p=0;for(;p<s;){let t=e.charAt(p);switch(u){case 0:"["==t?u=1:r+=t;break;case 1:"["==t?(u=0,r+=t):(u=2,l(),p--);break;case 2:"]"==t?u=3:r+=t;break;case 3:"]"==t?(u=2,r+=t):(u=0,c(),p--)}p++}for(3==u&&c(),l();i.length>0;){let e=[];n(i.pop(),e),o.push.apply(o,e)}return o.join("")},n.nanoTime=(t=e).process?function(){let e=process.hrtime();return 1e9*e[0]+e[1]}:t.performance?function(){return parseInt(1e6*t.performance.now(),10)}:function(){return 1e6*Date.now()};var a=function(){this.buffer=[]};a.prototype.append=function(e){return void 0!==e&&null!==e&&this.buffer.push(e.toString()),this},a.prototype.clear=function(){this.buffer.length=0},a.prototype.toString=function(){return this.buffer.join("")},a.prototype.length=function(){return this.toString().length};var r={ActionType:{},Cue:{},Identity:{},TraceType:{}};r.ActionType.GENERAL=0,r.ActionType.TRANSITIVE=1,r.ActionType.DITRANSITIVE=2,r.ActionType.MODAL=3,r.ActionType.OPEN=4,r.Cue.QUIT="quit",r.Cue.TEXT="text",r.Cue.TEXTF="textf",r.Cue.WAIT="wait",r.Cue.PAUSE="pause",r.Cue.TRACE="trace",r.Cue.ERROR="error",r.Cue.FATAL="fatal",r.Identity.ROOM="room",r.Identity.PLAYER="player",r.Identity.WORLD="world",r.TraceType.INTERPRETER="interpreter",r.TraceType.CONTEXT="context",r.TraceType.ENTRY="entry",r.TraceType.CONTROL="control",r.TraceType.FUNCTION="function",r.TraceType.INTERNAL="internal",r.TraceType.VALUE="value",r.TraceType.ALL=function(){let e={};for(let t in r.TraceType)r.TraceType.hasOwnProperty(t)&&(e[r.TraceType[t]]=!0);return e}(),r.DEFAULT_RUNAWAY_THRESHOLD=1e5,r.DEFAULT_FUNCTION_DEPTH=256,r.RETURN_VARIABLE="-. 0Return0 .-";var i=function(e,t){this.type=e,this.message=t};i.Type={Module:"Module",ModuleExecution:"ModuleExecution",ModuleState:"ModuleState",Arithmetic:"Arithmetic",ArithmeticStackState:"ArithmeticStackState",RunawayRequest:"RunawayRequest",UnexpectedValueType:"UnexpectedValueType",BadParameter:"BadParameter"},i.prototype.toString=function(){return"TAMEError: "+this.type+": "+this.message},i.Module=function(e){return new i(i.Type.Module,e)},i.ModuleExecution=function(e){return new i(i.Type.ModuleExecution,e)},i.ModuleState=function(e){return new i(i.Type.ModuleState,e)},i.Arithmetic=function(e){return new i(i.Type.Arithmetic,e)},i.ArithmeticStackState=function(e){return new i(i.Type.ArithmeticStackState,e)},i.RunawayRequest=function(e){return new i(i.Type.RunawayRequest,e)},i.UnexpectedValueType=function(e){return new i(i.Type.UnexpectedValueType,e)},i.BadParameter=function(e){return new i(i.Type.BadParameter,e)};var o=function(e,t){this.type=e,this.message=t};o.Type={Break:"Break",Continue:"Continue",Error:"Error",End:"End",Quit:"Quit",Finish:"Finish"},o.Break=function(){return new o(o.Type.Break,"A break interrupt was thrown!")},o.Continue=function(){return new o(o.Type.Continue,"A continue interrupt was thrown!")},o.Error=function(e){return new o(o.Type.Error,e)},o.End=function(){return new o(o.Type.End,"An end interrupt was thrown!")},o.Quit=function(){return new o(o.Type.Quit,"A quit interrupt was thrown!")},o.Finish=function(){return new o(o.Type.Finish,"A finish interrupt was thrown!")},o.prototype.toString=function(){return"TAMEInterrupt: "+this.type+": "+this.message};var l={Type:{BOOLEAN:"BOOLEAN",INTEGER:"INTEGER",FLOAT:"FLOAT",STRING:"STRING",LIST:"LIST",OBJECT:"OBJECT",CONTAINER:"CONTAINER",PLAYER:"PLAYER",ROOM:"ROOM",WORLD:"WORLD",ACTION:"ACTION",VARIABLE:"VARIABLE"},create:function(e,t){if(!e)throw i.UnexpectedValueType("Invalid value type in TValue()");if(void 0===t||null===t)throw i.UnexpectedValueType("Value cannot be undefined or null in TValue()");var n={};return n.type=e,n.value=t,n},createBoolean:function(e){return l.create(l.Type.BOOLEAN,Boolean(e))},createInteger:function(e){return l.create(l.Type.INTEGER,parseInt(e,10))},createFloat:function(e){return l.create(l.Type.FLOAT,parseFloat(e))},createString:function(e){return l.create(l.Type.STRING,String(e))},createList:function(e){return l.create(l.Type.LIST,e)},createWorld:function(){return l.create(l.Type.WORLD,"world")},createObject:function(e){return l.create(l.Type.OBJECT,String(e))},createContainer:function(e){return l.create(l.Type.CONTAINER,String(e))},createPlayer:function(e){return l.create(l.Type.PLAYER,String(e))},createRoom:function(e){return l.create(l.Type.ROOM,String(e))},createAction:function(e){return l.create(l.Type.ACTION,String(e))},createVariable:function(e){return l.create(l.Type.VARIABLE,String(e))},createNaN:function(){return l.create(l.Type.FLOAT,NaN)},createInfinity:function(){return l.create(l.Type.FLOAT,1/0)},createNegativeInfinity:function(){return l.create(l.Type.FLOAT,-1/0)},createValue:function(e){return l.create(e.type,e.value)},areEqualIgnoreType:function(e,t){return l.isLiteral(e)&&l.isLiteral(t)?l.isList(e)||l.isList(t)?l.areEqual(e,t):l.isString(e)&&l.isString(t)?e.value==t.value:l.asDouble(e)==l.asDouble(t):l.areEqual(e,t)},areEqual:function(e,t){return!l.isStrictlyNaN(e)&&(!l.isStrictlyNaN(t)&&(e.type===t.type&&e.value===t.value))},compare:function(e,t){if(l.areEqual(e,t))return 0;if(!l.isLiteral(e)||!l.isLiteral(t))return-Number.MAX_VALUE;if(l.isList(e)||l.isList(t))return-Number.MAX_VALUE;if(l.isString(e)||l.isString(t)){let a=l.asString(e),r=l.asString(t);return n.strcmp(a,r)}if(l.isFloatingPoint(e)||l.isFloatingPoint(t)){let n=l.asDouble(e),a=l.asDouble(t);return n===a?0:n<a?-1:1}if(l.isInteger(e)||l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return n===a?0:n<a?-1:1}if(l.isBoolean(e)||l.isBoolean(t)){let n=l.asBoolean(e);return n===l.asBoolean(t)?0:n?1:-1}return 0},absolute:function(e){return l.isInteger(e)?l.createInteger(Math.abs(l.asLong(e))):l.isNumeric(e)?l.createFloat(Math.abs(l.asDouble(e))):l.createNaN()},negate:function(e){return l.isInteger(e)?l.createInteger(-l.asLong(e)):l.isNumeric(e)?l.createFloat(-l.asDouble(e)):l.createNaN()},logicalNot:function(e){return l.isLiteral(e)?l.createBoolean(!l.asBoolean(e)):l.createNaN()},not:function(e){return l.isInfinite(e)?l.createInteger(-1):l.isNaN(e)?l.createInteger(-1):l.isBoolean(e)?l.createBoolean(!l.asBoolean(e)):l.isNumeric(e)?l.createInteger(~l.asLong(e)):l.isString(e)?l.createInteger(-1):l.createNaN()},add:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isBoolean(e)&&l.isBoolean(t)){let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n||a)}if(l.isString(e)||l.isString(t)){let n=l.asString(e),a=l.asString(t);return l.createString(n+a)}if(l.isInteger(e)&&l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return l.createInteger(n+a)}{let n=l.asDouble(e),a=l.asDouble(t);return l.createFloat(n+a)}},subtract:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isList(e)||l.isList(t))return l.createNaN();if(l.isString(e)||l.isString(t))return l.createNaN();if(l.isBoolean(e)&&l.isBoolean(t)){let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n&&!a)}if(l.isInteger(e)&&l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return l.createInteger(n-a)}{let n=l.asDouble(e),a=l.asDouble(t);return l.createFloat(n-a)}},multiply:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isList(e)||l.isList(t))return l.createNaN();if(l.isString(e)||l.isString(t))return l.createNaN();if(l.isBoolean(e)&&l.isBoolean(t)){let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n&&a)}if(l.isInteger(e)&&l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return l.createInteger(n*a)}{let n=l.asDouble(e),a=l.asDouble(t);return l.createFloat(n*a)}},divide:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isList(e)||l.isList(t))return l.createNaN();if(l.isString(e)||l.isString(t))return l.createNaN();if(l.isInteger(e)&&l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return 0===a?0!==n?n<0?l.createNegativeInfinity():l.createInfinity():l.createNaN():l.createInteger(n/a)}{let n=l.asDouble(e),a=l.asDouble(t);return 0===a?Number.isNaN(n)||0===n?l.createNaN():n<0?l.createNegativeInfinity():l.createInfinity():l.createFloat(n/a)}},modulo:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isList(e)||l.isList(t))return l.createNaN();if(l.isString(e)||l.isString(t))return l.createNaN();if(l.isInteger(e)&&l.isInteger(t)){let n=l.asLong(e),a=l.asLong(t);return 0===a?l.createNaN():l.createInteger(n%a)}{let n=l.asDouble(e),a=l.asDouble(t);return 0===a?l.createNaN():l.createFloat(n%a)}},power:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createNaN();if(l.isList(e)||l.isList(t))return l.createNaN();if(l.isString(e)||l.isString(t))return l.createNaN();let n=l.asDouble(e),a=l.asDouble(t),r=Math.pow(n,a);return l.createFloat(r)},logicalAnd:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createBoolean(!1);let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n&&a)},logicalOr:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createBoolean(!1);let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n||a)},logicalXOr:function(e,t){if(!l.isLiteral(e)||!l.isLiteral(t))return l.createBoolean(!1);let n=l.asBoolean(e),a=l.asBoolean(t);return l.createBoolean(n^a)},equals:function(e,t){return l.createBoolean(l.areEqualIgnoreType(e,t))},notEquals:function(e,t){return l.createBoolean(!l.areEqualIgnoreType(e,t))},strictEquals:function(e,t){return l.createBoolean(l.areEqual(e,t))},strictNotEquals:function(e,t){return l.createBoolean(!l.areEqual(e,t))},less:function(e,t){return l.isLiteral(e)&&l.isLiteral(t)?l.isList(e)||l.isList(t)?l.createBoolean(!1):l.isStrictlyNaN(e)||l.isStrictlyNaN(t)?l.createBoolean(!1):l.createBoolean(l.compare(e,t)<0):l.createBoolean(!1)},lessOrEqual:function(e,t){return l.isLiteral(e)&&l.isLiteral(t)?l.isList(e)||l.isList(t)?l.createBoolean(!1):l.isStrictlyNaN(e)||l.isStrictlyNaN(t)?l.createBoolean(!1):l.createBoolean(l.compare(e,t)<=0):l.createBoolean(!1)},greater:function(e,t){return l.isLiteral(e)&&l.isLiteral(t)?l.isList(e)||l.isList(t)?l.createBoolean(!1):l.isStrictlyNaN(e)||l.isStrictlyNaN(t)?l.createBoolean(!1):l.createBoolean(l.compare(e,t)>0):l.createBoolean(!1)},greaterOrEqual:function(e,t){return l.isLiteral(e)&&l.isLiteral(t)?l.isList(e)||l.isList(t)?l.createBoolean(!1):l.isStrictlyNaN(e)||l.isStrictlyNaN(t)?l.createBoolean(!1):l.createBoolean(l.compare(e,t)>=0):l.createBoolean(!1)},isBoolean:function(e){return e.type===l.Type.BOOLEAN},isInteger:function(e){return e.type===l.Type.INTEGER},isFloatingPoint:function(e){return e.type===l.Type.FLOAT},isNumeric:function(e){return e.type===l.Type.INTEGER||e.type===l.Type.FLOAT},isString:function(e){return e.type===l.Type.STRING},isList:function(e){return e.type===l.Type.LIST},isReferenceCopied:function(e){return e.type===l.Type.LIST},isLiteral:function(e){return e.type===l.Type.BOOLEAN||e.type===l.Type.INTEGER||e.type===l.Type.FLOAT||e.type===l.Type.STRING||e.type===l.Type.LIST},isElement:function(e){return e.type===l.Type.OBJECT||e.type===l.Type.PLAYER||e.type===l.Type.ROOM||e.type===l.Type.CONTAINER||e.type===l.Type.WORLD},isObjectContainer:function(e){return e.type===l.Type.PLAYER||e.type===l.Type.ROOM||e.type===l.Type.CONTAINER||e.type===l.Type.WORLD},isObject:function(e){return e.type===l.Type.OBJECT},isRoom:function(e){return e.type===l.Type.ROOM},isPlayer:function(e){return e.type===l.Type.PLAYER},isContainer:function(e){return e.type===l.Type.CONTAINER},isAction:function(e){return e.type===l.Type.ACTION},isVariable:function(e){return e.type===l.Type.VARIABLE},isBoolean:function(e){return e.type===l.Type.BOOLEAN},isNaN:function(e){return Number.isNaN(l.asDouble(e))},isStrictlyNaN:function(e){return l.isFloatingPoint(e)&&l.isNaN(e)},isInfinite:function(e){let t=l.asDouble(e);return t===1/0||t===-1/0},asLong:function(e){return l.isInfinite(e)||l.isNaN(e)?0:l.isBoolean(e)?l.asBoolean(e)?1:0:l.isInteger(e)?e.value:l.isFloatingPoint(e)?parseInt(e.value,10):l.isString(e)?parseInt(l.asDouble(e),10):0},asDouble:function(e){if(l.isBoolean(e))return l.asBoolean(e)?1:0;if(l.isInteger(e))return parseFloat(e.value);if(l.isFloatingPoint(e))return e.value;if(l.isString(e)){let t=e.value.toLowerCase();return"nan"===t?NaN:"infinity"===t?1/0:"-infinity"===t?-1/0:parseFloat(t)}return NaN},asString:function(e){if(l.isList(e)){let t=new a;t.append("[");for(let n=0;n<e.value.length;n++)t.append(l.asString(e.value[n])),n<e.value.length-1&&t.append(", ");return t.append("]"),t.toString()}if(l.isString(e)||l.isElement(e)||l.isVariable(e)||l.isAction(e))return e.value;if(l.isInfinite(e)||l.isNaN(e))return""+e.value;if(l.isFloatingPoint(e)){let t=l.asDouble(e);if(0===Math.abs(t))return"0.0";if(Math.abs(t)<.001||Math.abs(t)>=1e7){let e=t.toExponential().toUpperCase().replace("+","");if(e.indexOf(".")<0){let t=e.indexOf("E");return e.substring(0,t)+".0"+e.substring(t)}return e}return t%1==0?e.value+".0":""+e.value}return""+e.value},asBoolean:function(e){return l.isBoolean(e)?e.value:l.isFloatingPoint(e)?!!l.isInfinite(e)||!Number.isNaN(e.value)&&0!==l.asDouble(e):l.isInteger(e)?0!==l.asLong(e):!l.isString(e)||0!==e.value.length},isTrue:function(e){return l.asBoolean(e)},toString:function(e){let t=new a;if(t.append(e.type),t.append("["),l.isList(e)){t.append("[");for(let n=0;n<e.value.length;n++)t.append(l.toString(e.value[n])),n<e.value.length-1&&t.append(", ");t.append("]")}else t.append(l.asString(e));return t.append("]"),t.toString()},isEmpty:function(e){return!!l.isStrictlyNaN(e)||(l.isBoolean(e)?!l.asBoolean(e):l.isNumeric(e)?0===l.asDouble(e):l.isString(e)?0===l.asString(e).trim().length:!!l.isList(e)&&0===e.value.length)},length:function(e){return l.isList(e)?e.value.length:l.isString(e)?l.asString(e).length:1},listAdd:function(e,t){return!!l.isList(e)&&(e.value.push(l.createValue(t)),!0)},listAddAt:function(e,t,n){return!!l.isList(e)&&(!(t<0)&&(e.value.splice(t,0,l.createValue(n)),!0))},listSet:function(e,t,n){return!!l.isList(e)&&(!(t<0||t>=e.value.length)&&(e.value[t]=l.createValue(n),!0))},listGet:function(e,t){return l.isList(e)?t<0||t>=e.value.length?l.createBoolean(!1):l.createValue(e.value[t]):l.createBoolean(!1)},listIndexOf:function(e,t){if(!l.isList(e))return-1;for(let n=0;n<e.value.length;n++)if(l.areEqual(t,e.value[n]))return n;return-1},listContains:function(e,t){return l.listIndexOf(e,t)>=0},listRemove:function(e,t){if(!l.isList(e))return!1;let n=l.listIndexOf(e,t);return!(n<0)&&(e.value.splice(n,1),!0)},listRemoveAt:function(e,t){return l.isList(e)?t<0||t>=e.value.length?l.createBoolean(!1):l.createValue(e.value.splice(t,1)[0]):l.createBoolean(!1)}},c=function(e,t,n){this.moduleContext=e,this.inputMessage=t,this.traceTypesMap=n,this.commandQueue=[],this.valueStack=[],this.contextStack=[]};c.prototype.getInputMessage=function(){return this.inputMessage},c.prototype.traces=function(e){return this.traceTypesMap[e.toLowerCase()]},c.prototype.addCommand=function(e){this.commandQueue.push(e)},c.prototype.hasCommands=function(){return 0!==this.commandQueue.length},c.prototype.nextCommand=function(){return this.commandQueue.shift()},c.prototype.pushContext=function(e){this.contextStack.push(e)},c.prototype.popContext=function(){return this.contextStack.pop()},c.prototype.peekContext=function(){return this.contextStack[this.contextStack.length-1]},c.prototype.pushValue=function(e){this.valueStack.push(e)},c.prototype.popValue=function(){if(0===this.valueStack.length)throw i.ArithmeticStackState("Attempt to pop an empty arithmetic stack.");return this.valueStack.pop()},c.prototype.checkStackClear=function(){if(0!==this.valueStack.length)throw i.ArithmeticStackState("Arithmetic stack is not empty.")};var u=function(){this.responseCues=[],this.operationsExecuted=0,this.functionDepth=0,this.requestNanos=0,this.interpretNanos=0};u.prototype.addCue=function(e,t){t=void 0===t||null===t?"":String(t),this.responseCues.push({type:e,content:t})},u.prototype.trace=function(e,t,n){e.traces(t)&&this.addCue(r.Cue.TRACE+"-"+t,n)},u.prototype.incrementAndCheckOperationsExecuted=function(e){if(this.operationsExecuted++,this.operationsExecuted>=e)throw i.RunawayRequest("Too many operations executed - possible infinite loop.")},u.prototype.incrementAndCheckFunctionDepth=function(e){if(this.functionDepth++,this.functionDepth>=e)throw i.RunawayRequest("Too many function calls deep - possible stack overflow.")},u.prototype.decrementFunctionDepth=function(){this.functionDepth--};var s=function(e,t,n,a){this.action=e,this.target=t,this.object1=n,this.object2=a};function p(e,t,a,r){this.header=e,this.digest=t,this.actions=n.mapify(a,"identity"),this.elements={},this.actionNameTable={};let o=this.elements,l=this.actions,c=this.actionNameTable,u={TAction:!0,TObject:!0,TRoom:!0,TPlayer:!0,TContainer:!0,TWorld:!0};if(n.each(n.mapify(r,"identity"),function(e,t){if(t=t.toLowerCase(),!u[e.tameType])throw i.Module("Unknown element type: "+e.tameType);if(o[t]||l[t])throw i.Module("Another element already has the identity "+t);o[t]=e}),n.each(this.actions,function(e){if(!u[e.tameType])throw i.Module("Unknown element type: "+e.tameType);n.each(e.names,function(t){c[n.replaceAll(t.toLowerCase(),"\\s+"," ")]=e.identity})}),!this.elements.world)throw i.Module("No world element!")}s.create=function(e){return new s(e,null,null,null)},s.createModal=function(e,t){return new s(e,t,null,null)},s.createObject=function(e,t){return new s(e,null,t,null)},s.createObject2=function(e,t,n){return new s(e,null,t,n)},s.prototype.toString=function(){var e=new a;return e.append("Command "),e.append("["),this.action&&e.append(this.action.identity),this.target&&e.append(", ").append(this.target),this.object1&&e.append(", ").append(this.object1.identity),this.object2&&(this.object1.identity&&e.append(", "),e.append(this.object2.identity)),e.append("]"),e.toString()},p.prototype.getActionByName=function(e){let t=this.actionNameTable[e.toLowerCase()];return t?this.actions[t]:null};var d=function(e){this.module=e,this.state={},this.state.player=null,this.state.elements={},this.state.owners={},this.state.objectOwners={},this.state.roomStacks={},this.state.names={},this.state.tags={};var t=this.state,a=this.module,o=this;n.each(a.elements,function(e,a){if(a=a.toLowerCase(),!e.archetype){if(t.elements[a])throw i.Module("Another element already has the identity "+a);t.elements[a]={identity:a,variables:{}},"TObject"===e.tameType&&(t.names[a]={},t.tags[a]={},n.each(e.names,function(t){o.addObjectName(e.identity,t)}),n.each(e.tags,function(t){o.addObjectTag(e.identity,t)}))}});var l=parseInt(e.header.tame_runaway_max,10),c=parseInt(e.header.tame_funcdepth_max,10);this.operationRunawayMax=l<=0||isNaN(l)?r.DEFAULT_RUNAWAY_THRESHOLD:l,this.functionDepthMax=c<=0||isNaN(c)?r.DEFAULT_FUNCTION_DEPTH:c};d.prototype.stateSave=function(){var e=function(t,n,a,r){if(l.isReferenceCopied(t)){if(a.has(t.value))return{refid:a.get(t.value)};{if(t.type===l.Type.LIST){let i=t.value;for(let t=0;t<i.length;t++)i[t]=e(i[t],n,a,r)}let i=n[0]+=1;return r[i]=t,a.set(t.value,i),{refid:i}}}return t};let t=this.state;t.refMap={};let n=[0],a=new WeakMap;for(let r in t.elements)if(t.elements.hasOwnProperty(r)){let i=t.elements[r];for(let r in i.variables)i.variables.hasOwnProperty(r)&&(i.variables[r]=e(i.variables[r],n,a,t.refMap))}let r=JSON.stringify(t);return this.stateRestore(r),r},d.prototype.stateRestore=function(e){this.state=JSON.parse(e);let t=this.state;if(!t.refMap)throw i.ModuleState("Context state is missing required member: refMap");var n=function(e,t){if(e.refid){let a=t[e.refid];if(a.type===l.Type.LIST){let e=a.value;for(let a=0;a<e.length;a++)e[a]=n(e[a],t)}return a}return e};for(let e in t.elements)if(t.elements.hasOwnProperty(e)){let a=t.elements[e];for(let e in a.variables)a.variables.hasOwnProperty(e)&&(a.variables[e]=n(a.variables[e],t.refMap))}delete t.refMap,console.log(JSON.stringify(t))},d.prototype.setCurrentPlayer=function(e){let t=this.state;if(!t)throw i.ModuleState("Context is invalid or null");if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);t.player=e},d.prototype.removePlayer=function(e){let t=this.state;if(!t)throw i.ModuleState("Context is invalid or null");if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);delete t.roomStacks[e]},d.prototype.pushRoomOntoPlayer=function(e,t){let n=this.state;if(!n.elements)throw i.ModuleState("Context state is missing required member: elements");if(!n.roomStacks)throw i.ModuleState("Context state is missing required member: roomStacks");if(e=e.toLowerCase(),t=t.toLowerCase(),!n.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);if(!n.elements[t])throw i.ModuleExecution("Element is missing from context state: "+t);n.roomStacks[e]||(n.roomStacks[e]=[]),n.roomStacks[e].push(t)},d.prototype.popRoomFromPlayer=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.roomStacks)throw i.ModuleState("Context state is missing required member: roomStacks");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);if(!t.roomStacks[e])return;let n=t.roomStacks[e].pop();return t.roomStacks[e].length||delete t.roomStacks[e],n},d.prototype.checkPlayerIsInRoom=function(e,t){let n=this.state;if(!n.elements)throw i.ModuleState("Context state is missing required member: elements");if(!n.roomStacks)throw i.ModuleState("Context state is missing required member: roomStacks");if(e=e.toLowerCase(),t=t.toLowerCase(),!n.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);if(!n.elements[t])throw i.ModuleExecution("Element is missing from context state: "+t);let a=n.roomStacks[e];return!!a&&a.indexOf(t)>=0},d.prototype.removeObject=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.objectOwners)throw i.ModuleState("Context state is missing required member: objectOwners");if(!t.owners)throw i.ModuleState("Context state is missing required member: owners");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);let a=t.objectOwners[e];a&&(delete t.objectOwners[e],n.arrayRemove(t.owners[a],e))},d.prototype.addObjectToElement=function(e,t){let n=this.state;if(!n.elements)throw i.ModuleState("Context state is missing required member: elements");if(!n.objectOwners)throw i.ModuleState("Context state is missing required member: objectOwners");if(!n.owners)throw i.ModuleState("Context state is missing required member: owners");if(e=e.toLowerCase(),t=t.toLowerCase(),!n.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);if(!n.elements[t])throw i.ModuleExecution("Element is missing from context state: "+t);this.removeObject(t),n.objectOwners[t]=e,n.owners[e]||(n.owners[e]=[]),n.owners[e].push(t)},d.prototype.checkElementHasObject=function(e,t){let n=this.state;if(!n.elements)throw i.ModuleState("Context state is missing required member: elements");if(!n.objectOwners)throw i.ModuleState("Context state is missing required member: objectOwners");if(e=e.toLowerCase(),t=t.toLowerCase(),!n.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);if(!n.elements[t])throw i.ModuleExecution("Element is missing from context state: "+t);return n.objectOwners[t]==e},d.prototype.checkObjectHasNoOwner=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.objectOwners)throw i.ModuleState("Context state is missing required member: objectOwners");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);return!t.objectOwners[e]},d.prototype.getObjectsOwnedByElement=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.owners)throw i.ModuleState("Context state is missing required member: owners");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);let n=t.owners[e];return n?n.slice():[]},d.prototype.getObjectsOwnedByElementCount=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.owners)throw i.ModuleState("Context state is missing required member: owners");if(e=e.toLowerCase(),!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);let n=t.owners[e];return n?n.length:0},d.prototype.addObjectName=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.names)throw i.ModuleState("Context state is missing required member: names");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);let r=this.getElement(e);t=n.replaceAll(t.trim().toLowerCase(),"\\s+"," "),n.objectStringAdd(a.names,e,t),n.each(r.determiners,function(r){r=n.replaceAll(r.trim().toLowerCase(),"\\s+"," "),n.objectStringAdd(a.names,e,r+" "+t)})},d.prototype.removeObjectName=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.names)throw i.ModuleState("Context state is missing required member: names");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);var r=this.getElement(e);t=n.replaceAll(t.trim().toLowerCase(),"\\s+"," "),n.objectStringRemove(a.names,e,t),n.each(r.determiners,function(r){r=n.replaceAll(r.trim().toLowerCase(),"\\s+"," "),n.objectStringRemove(a.names,e,r+" "+t)})},d.prototype.checkObjectHasName=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.names)throw i.ModuleState("Context state is missing required member: names");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);return t=t.toLowerCase(),n.objectStringContains(a.names,e,t)},d.prototype.addObjectTag=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.tags)throw i.ModuleState("Context state is missing required member: tags");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);t=t.toLowerCase(),n.objectStringAdd(a.tags,e,t)},d.prototype.removeObjectTag=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.tags)throw i.ModuleState("Context state is missing required member: tags");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);t=t.toLowerCase(),n.objectStringRemove(a.tags,e,t)},d.prototype.checkObjectHasTag=function(e,t){let a=this.state;if(!a.elements)throw i.ModuleState("Context state is missing required member: elements");if(!a.tags)throw i.ModuleState("Context state is missing required member: tags");if(e=e.toLowerCase(),!a.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);return t=t.toLowerCase(),n.objectStringContains(a.tags,e,t)},d.prototype.getElement=function(e){return this.module.elements[e.toLowerCase()]},d.prototype.getElementContext=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");return t.elements[e.toLowerCase()]},d.prototype.getCurrentPlayer=function(){let e=this.state;if(!e.elements)throw i.ModuleState("Context state is missing required member: elements");return e.player?this.getElement(e.player):null},d.prototype.getCurrentPlayerContext=function(){let e=this.getCurrentPlayer();return e?this.getElementContext(e.identity):null},d.prototype.getCurrentRoom=function(e){let t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");if(!t.roomStacks)throw i.ModuleState("Context state is missing required member: roomStacks");if(!(e=e?e.toLowerCase():t.player))return null;if(!t.elements[e])throw i.ModuleExecution("Element is missing from context state: "+e);let n=t.roomStacks[e];return n?this.getElement(n[n.length-1]):null},d.prototype.getCurrentRoomContext=function(e){let t=this.getCurrentRoom(e);return t?this.getElementContext(t.identity):null},d.prototype.resolveAction=function(e){if(!this.module.actions[e])throw i.ModuleExecution("Action is missing from module: "+e);return this.module.actions[e]},d.prototype.resolveElement=function(e){var t=null;if("player"===(e=e.toLowerCase())){if(!(t=this.getCurrentPlayer()))throw i.ModuleExecution("Current player context called with no current player!");return t}if("room"===e){if(!this.getCurrentPlayer())throw i.ModuleExecution("Current room context called with no current player!");if(!(t=this.getCurrentRoom()))throw i.ModuleExecution("Current room context called with no current room!");return t}if(!(t=this.getElement(e)))throw i.ModuleExecution("Expected element '"+e+"' in module!");return t},d.prototype.resolveElementContext=function(e){var t=this.state;if(!t.elements)throw i.ModuleState("Context state is missing required member: elements");var n=this.resolveElement(e),a=n.identity.toLowerCase();if(!t.elements[a])throw i.ModuleExecution("Element is missing from context state: "+n.identity);return t.elements[a]},d.prototype.resolveBlockName=function(e,t){var n=e+"(";if(t)for(var a=0;a<t.length;a++)n+=l.toString(t[a]),a<t.length-1&&(n+=",");return n+=")"},d.prototype.resolveBlock=function(e,t,n){for(var a=this.resolveBlockName(t,n),r=this.resolveElement(e);r;){var i=r.blockTable[a];if(i)return i;r=r.parent?this.resolveElement(r.parent):null}return null},d.prototype.resolveFunction=function(e,t){var n=this.resolveElement(e);for(t=t.toLowerCase();n;){var a=n.functionTable[t];if(a)return a;n=n.parent?this.resolveElement(n.parent):null}return null},d.prototype.getAccessibleObjectsByName=function(e,t,n){var a=this.getCurrentPlayerContext(),r=this.getCurrentRoomContext(),i=this.getElementContext("world"),o=n,l=null;if(null!==a){l=this.getObjectsOwnedByElement(a.identity);for(let a in l)if(l.hasOwnProperty(a)){var c=l[a];if(this.checkObjectHasName(c,e)&&(t[n++]=this.getElement(c),n==t.length))return n-o}}if(null!==r){l=this.getObjectsOwnedByElement(r.identity);for(let a in l)if(l.hasOwnProperty(a)){let r=l[a];if(this.checkObjectHasName(r,e)&&(t[n++]=this.getElement(r),n==t.length))return n-o}}l=this.getObjectsOwnedByElement(i.identity);for(let a in l)if(l.hasOwnProperty(a)){let r=l[a];if(this.checkObjectHasName(r,e)&&(t[n++]=this.getElement(r),n==t.length))return n-o}return n-o};var T=function(e,t){this.dataView=e,this.littleEndian=t,this.pos=0};T.prototype.split=function(e){let t=this.dataView.buffer;return new T(new DataView(t.slice(this.pos,this.pos+e)),this.littleEndian)},T.prototype.readInt8=function(){let e=this.dataView.getInt8(this.pos);return this.pos=this.pos+1,e},T.prototype.readUInt8=function(){let e=this.dataView.getUint8(this.pos);return this.pos=this.pos+1,e},T.prototype.readBoolean=function(){return 0!==this.readUInt8()},T.prototype.readBytes=function(e){let t=[];for(;e--;)t.push(this.readUInt8());return t},T.prototype.readInt16=function(){let e=this.dataView.getInt16(this.pos,this.littleEndian);return this.pos=this.pos+2,e},T.prototype.readUInt16=function(){let e=this.dataView.getUint16(this.pos,this.littleEndian);return this.pos=this.pos+2,e},T.prototype.readInt32=function(){let e=this.dataView.getInt32(this.pos,this.littleEndian);return this.pos=this.pos+4,e},T.prototype.readUInt32=function(){let e=this.dataView.getUint32(this.pos,this.littleEndian);return this.pos=this.pos+4,e},T.prototype.readInt64=function(){let e=0,t=0;return this.littleEndian?(e=this.readUInt32(),t=this.readUInt32()):(t=this.readUInt32(),e=this.readUInt32()),2147483648&t?Math.pow(2,32)*(2097151&t)+e-9007199254740992:Math.pow(2,32)*(2097151&t)+e},T.prototype.readFloat32=function(){let e=this.dataView.getFloat32(this.pos,this.littleEndian);return this.pos=this.pos+4,e},T.prototype.readFloat64=function(){let e=this.dataView.getFloat64(this.pos,this.littleEndian);return this.pos=this.pos+8,e},T.prototype.readASCIIChar=function(){let e=this.readUInt8();return String.fromCharCode(e)},T.prototype.readUTF8Char=function(){let e=this.readUInt8();switch(e>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:return String.fromCodePoint(e);case 12:case 13:{let t=this.readUInt8();return String.fromCodePoint((31&e)<<6|63&t)}case 14:{let t=this.readUInt8(),n=this.readUInt8();return String.fromCodePoint((15&e)<<12|(63&t)<<6|(63&n)<<0)}case 15:{let t=this.readUInt8(),n=this.readUInt8(),a=this.readUInt8();return String.fromCodePoint((7&e)<<18|(63&t)<<12|(63&n)<<6|63&a)}default:throw new RangeError("Bad UTF-8 character encoding.")}};var E={BlockEntryType:["INIT","START","AFTERSUCCESSFULCOMMAND","AFTERFAILEDCOMMAND","AFTEREVERYCOMMAND","ONACTION","ONMODALACTION","ONACTIONWITH","ONACTIONWITHANCESTOR","ONACTIONWITHOTHER","ONUNHANDLEDACTION","ONUNKNOWNCOMMAND","ONAMBIGUOUSCOMMAND","ONINCOMPLETECOMMAND","ONMALFORMEDCOMMAND","ONELEMENTBROWSE","ONWORLDBROWSE","ONROOMBROWSE","ONPLAYERBROWSE","ONCONTAINERBROWSE"],readASCII:function(e,t){let n="";for(;t--;)n+=e.readASCIIChar();return n},utf8BytesToString:function(e){let t="",n=0;for(;n<e.length;){let a=e[n++];switch(a>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:t+=String.fromCodePoint(a);continue;case 12:case 13:{let r=e[n++];t+=String.fromCodePoint((31&a)<<6|63&r);continue}case 14:{let r=e[n++],i=e[n++];t+=String.fromCodePoint((15&a)<<12|(63&r)<<6|(63&i)<<0);continue}case 15:{let r=e[n++],i=e[n++],o=e[n++];t+=String.fromCodePoint((7&a)<<18|(63&r)<<12|(63&i)<<6|63&o);continue}default:throw new Error("Bad UTF-8 character encoding in ["+e.toString()+"]")}}return t},readUTF8String:function(e){let t=e.readInt32(),n=e.readBytes(t);return E.utf8BytesToString(n)},readVariableLengthInt:function(e){let t=0,n=0;do{t|=127&(n=e.readUInt8()),0!=(128&n)&&(t<<=7)}while(0!=(128&n));return t},readUTF8StringArray:function(e){let t=[],n=e.readInt32();for(;n--;)t.push(E.readUTF8String(e));return t},readUTF8StringMap:function(e){let t={},n=e.readInt32();for(;n--;)t[E.readUTF8String(e)]=E.readUTF8String(e);return t},readValue:function(e){switch(e.readUInt8()){case 0:return l.createBoolean(e.readBoolean());case 1:return l.createInteger(e.readInt64());case 2:return l.createFloat(e.readFloat64());case 3:return l.createString(E.readUTF8String(e));case 4:let t=l.createList([]),n=e.readInt32();for(;n--;)l.listAdd(t,E.readValue(e));return t;case 5:return l.createObject(E.readUTF8String(e));case 6:return l.createContainer(E.readUTF8String(e));case 7:return l.createPlayer(E.readUTF8String(e));case 8:return l.createRoom(E.readUTF8String(e));case 9:return l.createWorld(E.readUTF8String(e));case 10:return l.createAction(E.readUTF8String(e));case 11:return l.createVariable(E.readUTF8String(e));default:throw i.Module("Bad value type. Internal error!")}},readOperation:function(e){let t={};t.opcode=E.readVariableLengthInt(e);let n=e.readUInt8();return 0!=(1&n)&&(t.operand0=E.readValue(e)),0!=(2&n)&&(t.operand1=E.readValue(e)),0!=(4&n)&&(t.initBlock=E.readBlock(e)),0!=(8&n)&&(t.conditionalBlock=E.readBlock(e)),0!=(16&n)&&(t.stepBlock=E.readBlock(e)),0!=(32&n)&&(t.successBlock=E.readBlock(e)),0!=(64&n)&&(t.failureBlock=E.readBlock(e)),t},readBlock:function(e){let t=[],n=e.readInt32();for(;n--;)t.push(E.readOperation(e));return t},readBlockEntryKey:function(e){let t="";t+=E.BlockEntryType[e.readUInt8()];let n=e.readInt32();for(t+="(";n--;)t+=l.toString(E.readValue(e)),n>0&&(t+=",");return t+=")"},readBlockTable:function(e){let t={},n=e.readInt32();for(;n--;){let n=E.readBlockEntryKey(e),a=E.readBlock(e);t[n]=a}return t},readFunctionEntry:function(e){let t={},n=e.readInt32();for(t.arguments=[];n--;)t.arguments.push(E.readUTF8String(e));return t.block=E.readBlock(e),t},readFunctionTable:function(e){let t={},n=e.readInt32();for(;n--;){let n=E.readUTF8String(e).toLowerCase(),a=E.readFunctionEntry(e);t[n]=a}return t},readElement:function(e,t){t.identity=E.readUTF8String(e),t.archetype=e.readBoolean(),t.blockTable=E.readBlockTable(e),t.functionTable=E.readFunctionTable(e)},readContainer:function(e){let t={tameType:"TContainer"};return E.readElement(e,t),t},readObject:function(e){let t={tameType:"TObject"};return E.readElement(e,t),t.names=E.readUTF8StringArray(e),t.determiners=E.readUTF8StringArray(e),t.tags=E.readUTF8StringArray(e),t},readRoom:function(e){let t={tameType:"TRoom"};return E.readElement(e,t),t},readPlayer:function(e){let t={tameType:"TPlayer"};return E.readElement(e,t),t},readWorld:function(e){let t={tameType:"TWorld"};return E.readElement(e,t),t},readAction:function(e){let t={tameType:"TAction"};t.identity=E.readUTF8String(e),t.type=e.readUInt8();let n=e.readUInt8();return t.strict=0!=(1&n),t.reversed=0!=(2&n),t.names=E.readUTF8StringArray(e),t.extraStrings=E.readUTF8StringArray(e),t},readModuleV1:function(e,t){t.digest=e.readBytes(20);let a=e.readInt32(),r=(e.split(a),[]),i=[],o={},l=E.readWorld(e);i[l.identity]=l;let c=function(t){let n=e.readInt32();for(;n--;){let n=t(e);o[n.identity]=n,i.push(n)}},u=function(){let t=E.readUTF8StringMap(e);n.each(t,(e,t)=>{o[t].parent=e})};for(count=e.readInt32();count--;)r.push(E.readAction(e));c(E.readPlayer),c(E.readRoom),c(E.readObject),c(E.readContainer),u(),u(),u(),u(),t.actions=r,t.elements=i},readModuleHeader:function(e){let t={},n=e.readInt32();for(;n--;){let n=E.readUTF8String(e),a=E.readUTF8String(e);t[n]=a}return t},readModule:function(e){let t=new T(e,!0);if("TAME"!=E.readASCII(t,4))throw i.Module("Not a TAME Module.");let n={};if(n.header=E.readModuleHeader(t),1!==t.readUInt8())throw i.Module("Module does not have a recognized version.");return E.readModuleV1(t,n),new p(n.header,n.digest,n.actions,n.elements)}},m={},f=[{name:"ABSOLUTE",symbol:"+",binary:!1,doOperation:l.absolute},{name:"NEGATE",symbol:"-",binary:!1,doOperation:l.negate},{name:"LOGICAL_NOT",symbol:"!",binary:!1,doOperation:l.logicalNot},{name:"ADD",symbol:"+",binary:!0,doOperation:l.add},{name:"SUBTRACT",symbol:"-",binary:!0,doOperation:l.subtract},{name:"MULTIPLY",symbol:"*",binary:!0,doOperation:l.multiply},{name:"DIVIDE",symbol:"/",binary:!0,doOperation:l.divide},{name:"MODULO",symbol:"%",binary:!0,doOperation:l.modulo},{name:"POWER",symbol:"**",binary:!0,doOperation:l.power},{name:"LOGICAL_AND",symbol:"&",binary:!0,doOperation:l.logicalAnd},{name:"LOGICAL_OR",symbol:"|",binary:!0,doOperation:l.logicalOr},{name:"LOGICAL_XOR",symbol:"^",binary:!0,doOperation:l.logicalXOr},{name:"EQUALS",symbol:"==",binary:!0,doOperation:l.equals},{name:"NOT_EQUALS",symbol:"!=",binary:!0,doOperation:l.notEquals},{name:"STRICT_EQUALS",symbol:"===",binary:!0,doOperation:l.strictEquals},{name:"STRICT_NOT_EQUALS",symbol:"!==",binary:!0,doOperation:l.strictNotEquals},{name:"LESS",symbol:"<",binary:!0,doOperation:l.less},{name:"LESS_OR_EQUAL",symbol:"<=",binary:!0,doOperation:l.lessOrEqual},{name:"GREATER",symbol:">",binary:!0,doOperation:l.greater},{name:"GREATER_OR_EQUAL",symbol:">=",binary:!0,doOperation:l.greaterOrEqual}];f.Type={ABSOLUTE:0,NEGATE:1,LOGICAL_NOT:2,ADD:3,SUBTRACT:4,MULTIPLY:5,DIVIDE:6,MODULO:7,POWER:8,LOGICAL_AND:9,LOGICAL_OR:10,LOGICAL_XOR:11,EQUALS:12,NOT_EQUALS:13,STRICT_EQUALS:14,STRICT_NOT_EQUALS:15,LESS:16,LESS_OR_EQUAL:17,GREATER:18,GREATER_OR_EQUAL:19},f.COUNT=f.Type.length;var y=[{name:"NOOP",doOperation:function(e,t,n,a){}},{name:"POP",internal:!0,doOperation:function(e,t,n,a){e.popValue()}},{name:"POPVALUE",internal:!0,doOperation:function(e,t,a,o){let c=o.operand0,u=e.popValue();if(!l.isLiteral(u))throw i.UnexpectedValueType("Expected literal type in POPVALUE call.");if(!l.isVariable(c))throw i.UnexpectedValueType("Expected variable type in POPVALUE call.");let s=l.asString(c);m.containsValue(a,s)?(t.trace(e,r.TraceType.VALUE,n.format("SET LOCAL {0} {1}",s,l.toString(u))),m.setValue(a,s,u)):(t.trace(e,r.TraceType.VALUE,n.format("SET {0}.{1} {2}",e.peekContext().identity,s,l.toString(u))),m.setValue(e.peekContext().variables,s,u))}},{name:"POPLOCALVALUE",internal:!0,doOperation:function(e,t,a,o){let c=o.operand0,u=e.popValue();if(!l.isLiteral(u))throw i.UnexpectedValueType("Expected literal type in POPLOCALVALUE call.");if(!l.isVariable(c))throw i.UnexpectedValueType("Expected variable type in POPLOCALVALUE call.");let s=l.asString(c);t.trace(e,r.TraceType.VALUE,n.format("SET LOCAL {0} {1}",s,l.toString(u))),m.setValue(a,s,u)}},{name:"POPELEMENTVALUE",internal:!0,doOperation:function(e,t,a,o){let c=o.operand0,u=o.operand1,s=e.popValue();if(!l.isLiteral(s))throw i.UnexpectedValueType("Expected literal type in POPELEMENTVALUE call.");if(!l.isVariable(u))throw i.UnexpectedValueType("Expected variable type in POPELEMENTVALUE call.");if(!l.isElement(c))throw i.UnexpectedValueType("Expected element type in POPELEMENTVALUE call.");let p=l.asString(c),d=l.asString(u),T=e.moduleContext.resolveElementContext(p);t.trace(e,r.TraceType.VALUE,n.format("SET {0}.{1} {2}",T.identity,d,l.toString(s))),m.setValue(T.variables,d,s)}},{name:"POPLISTVALUE",internal:!0,doOperation:function(e,t,a,o){let c=e.popValue(),u=e.popValue(),s=e.popValue();if(!l.isLiteral(u))throw i.UnexpectedValueType("Expected literal type in POPLISTVALUE call.");if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in POPLISTVALUE call.");if(!l.isLiteral(s))throw i.UnexpectedValueType("Expected literal type in POPLISTVALUE call.");l.isList(s)&&(t.trace(e,r.TraceType.VALUE,n.format("SET LIST [{0}] {1}",l.asLong(u),l.toString(c))),l.listSet(s,l.asLong(u),c))}},{name:"PUSHVALUE",internal:!0,doOperation:function(e,t,n,a){let r=a.operand0;if(l.isVariable(r)){let t=l.asString(r);m.containsValue(n,t)?e.pushValue(m.getValue(n,t)):e.pushValue(m.getValue(e.peekContext().variables,t))}else e.pushValue(r)}},{name:"PUSHELEMENTVALUE",internal:!0,doOperation:function(e,t,n,a){let r=a.operand0,o=a.operand1;if(!l.isVariable(o))throw i.UnexpectedValueType("Expected variable type in PUSHELEMENTVALUE call.");if(!l.isElement(r))throw i.UnexpectedValueType("Expected element type in PUSHELEMENTVALUE call.");let c=l.asString(r),u=l.asString(o);e.pushValue(m.getValue(e.moduleContext.resolveElementContext(c).variables,u))}},{name:"PUSHLISTVALUE",internal:!0,doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in PUSHLISTVALUE call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in PUSHLISTVALUE call.");l.isList(o)?e.pushValue(l.listGet(o,l.asLong(r))):e.pushValue(l.createBoolean(!1))}},{name:"PUSHNEWLIST",internal:!0,doOperation:function(e,t,n,a){e.pushValue(l.createList([]))}},{name:"PUSHINITLIST",internal:!0,doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in PUSHINITLIST call.");let o=l.asLong(r),c=l.createList([]);for(;o-- >0;){let t=e.popValue();if(!l.isLiteral(t)&&!l.isList(t))throw i.UnexpectedValueType("Expected literal or list type in PUSHINITLIST call.");l.listAddAt(c,0,t)}e.pushValue(c)}},{name:"CLEARVALUE",internal:!0,doOperation:function(e,t,a,o){let c=o.operand0;if(!l.isVariable(c))throw i.UnexpectedValueType("Expected variable type in CLEARVALUE call.");let u=l.asString(c).toLowerCase();a[u]?(t.trace(e,r.TraceType.VALUE,n.format("CLEAR LOCAL {0}",u)),m.clearValue(a,u)):(t.trace(e,r.TraceType.VALUE,n.format("CLEAR {0}.{1}",e.peekContext().identity,u)),m.clearValue(e.peekContext().variables,u))}},{name:"CLEARELEMENTVALUE",internal:!0,doOperation:function(e,t,a,o){let c=o.operand0,u=o.operand1;if(!l.isVariable(u))throw i.UnexpectedValueType("Expected variable type in CLEARELEMENTVALUE call.");if(!l.isElement(c))throw i.UnexpectedValueType("Expected element type in CLEARELEMENTVALUE call.");let s=l.asString(u).toLowerCase(),p=e.moduleContext.resolveElementContext(l.asString(c));t.trace(e,r.TraceType.VALUE,n.format("CLEAR {0}.{1}",p.identity,s)),m.clearValue(p.variables,l.asString(u))}},{name:"PUSHTHIS",internal:!0,doOperation:function(e,t,n,a){let r=e.moduleContext.resolveElement(e.peekContext().identity);if("TObject"===r.tameType)e.pushValue(l.createObject(r.identity));else if("TRoom"===r.tameType)e.pushValue(l.createRoom(r.identity));else if("TPlayer"===r.tameType)e.pushValue(l.createPlayer(r.identity));else if("TContainer"===r.tameType)e.pushValue(l.createContainer(r.identity));else{if("TWorld"!==r.tameType)throw i.ModuleExecution("Internal error - invalid object type for PUSHTHIS.");e.pushValue(l.createWorld())}}},{name:"ARITHMETICFUNC",internal:!0,doOperation:function(e,t,n,a){let r=a.operand0;if(!l.isInteger(r))throw i.UnexpectedValueType("Expected integer type in ARITHMETICFUNC call.");m.doArithmeticStackFunction(e,t,l.asLong(r))}},{name:"IF",internal:!0,doOperation:function(e,t,n,a){if(m.callConditional("IF",e,t,n,a)){let r=a.successBlock;if(!r)throw i.ModuleExecution("Success block for IF does NOT EXIST!");m.executeBlock(r,e,t,n)}else{let r=a.failureBlock;r&&m.executeBlock(r,e,t,n)}}},{name:"WHILE",internal:!0,doOperation:function(e,t,n,a){for(;m.callConditional("WHILE",e,t,n,a);)try{let r=a.successBlock;if(!r)throw i.ModuleExecution("Success block for WHILE does NOT EXIST!");m.executeBlock(r,e,t,n)}catch(e){if(e instanceof o){if(e.type===o.Type.Break)break;if(e.type===o.Type.Continue)continue;throw e}throw e}}},{name:"FOR",internal:!0,doOperation:function(e,t,n,a){let l=a.initBlock;if(!l)throw i.ModuleExecution("Init block for FOR does NOT EXIST!");let c=a.successBlock;if(!c)throw i.ModuleExecution("Success block for FOR does NOT EXIST!");let u=a.stepBlock;if(!u)throw i.ModuleExecution("Step block for FOR does NOT EXIST!");for(t.trace(e,r.TraceType.CONTROL,"FOR Init"),m.executeBlock(l,e,t,n);m.callConditional("FOR",e,t,n,a);t.trace(e,r.TraceType.CONTROL,"FOR Step"),m.executeBlock(u,e,t,n))try{t.trace(e,r.TraceType.CONTROL,"FOR Success"),m.executeBlock(c,e,t,n)}catch(e){if(e instanceof o){if(e.type===o.Type.Break)break;if(e.type===o.Type.Continue)continue;throw e}throw e}}},{name:"BREAK",internal:!0,doOperation:function(e,t,n,a){throw t.trace(e,r.TraceType.CONTROL,"THROW BREAK"),o.Break()}},{name:"CONTINUE",internal:!0,doOperation:function(e,t,n,a){throw t.trace(e,r.TraceType.CONTROL,"THROW CONTINUE"),o.Continue()}},{name:"QUIT",internal:!0,doOperation:function(e,t,n,a){throw t.trace(e,r.TraceType.CONTROL,"THROW QUIT"),t.addCue(r.Cue.QUIT),o.Quit()}},{name:"FINISH",internal:!0,doOperation:function(e,t,n,a){throw t.trace(e,r.TraceType.CONTROL,"THROW FINISH"),o.Finish()}},{name:"END",internal:!0,doOperation:function(e,t,n,a){throw t.trace(e,r.TraceType.CONTROL,"THROW END"),o.End()}},{name:"FUNCTIONRETURN",internal:!0,doOperation:function(e,t,n,a){let i=e.popValue();throw t.trace(e,r.TraceType.FUNCTION,"RETURN "+l.toString(i)),m.setValue(n,r.RETURN_VARIABLE,i),t.trace(e,r.TraceType.CONTROL,"THROW END"),o.End()}},{name:"CALLFUNCTION",internal:!0,doOperation:function(e,t,n,a){let r=a.operand0;if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in CALLFUNCTION call.");e.pushValue(m.callElementFunction(e,t,l.asString(r),e.peekContext()))}},{name:"CALLELEMENTFUNCTION",internal:!0,doOperation:function(e,t,n,a){let r=a.operand0,o=a.operand1;if(!l.isElement(r))throw i.UnexpectedValueType("Expected element type in CALLELEMENTFUNCTION call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in CALLELEMENTFUNCTION call.");let c=e.moduleContext.resolveElementContext(l.asString(r));e.pushValue(m.callElementFunction(e,t,l.asString(o),c))}},{name:"QUEUEACTION",internal:!0,doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isAction(o))throw i.UnexpectedValueType("Expected action type in QUEUEACTION call.");let c=e.moduleContext.resolveAction(l.asString(o));if(c.type!=r.ActionType.GENERAL)throw i.UnexpectedValueType("BAD TYPE: "+c.identity+" is not a general action.");let u=s.create(c);e.addCommand(u),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+u.toString())}},{name:"QUEUEACTIONSTRING",internal:!0,doOperation:function(e,t,n,a){let c=e.popValue(),u=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in QUEUEACTIONSTRING call.");if(!l.isAction(u))throw i.UnexpectedValueType("Expected action type in QUEUEACTIONSTRING call.");let p=e.moduleContext.resolveAction(l.asString(u));if(p.type!=r.ActionType.MODAL&&p.type!=r.ActionType.OPEN)throw o.Error(p.identity+" is not a modal nor open action.");let d=s.createModal(p,l.asString(c));e.addCommand(d),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+d.toString())}},{name:"QUEUEACTIONOBJECT",internal:!0,doOperation:function(e,t,n,a){let o=e.popValue(),c=e.popValue();if(!l.isObject(o))throw i.UnexpectedValueType("Expected literal type in QUEUEACTIONOBJECT call.");if(!l.isAction(c))throw i.UnexpectedValueType("Expected action type in QUEUEACTIONOBJECT call.");let u=e.moduleContext.resolveAction(l.asString(c)),p=e.moduleContext.resolveElement(l.asString(o));if(u.type!=r.ActionType.TRANSITIVE&&u.type!=r.ActionType.DITRANSITIVE)throw i.UnexpectedValueType("BAD TYPE: "+u.identity+" is not a transitive nor ditransitive action.");let d=s.createObject(u,p);e.addCommand(d),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+d.toString())}},{name:"QUEUEACTIONFOROBJECTSIN",internal:!0,doOperation:function(e,t,a,o){let c=e.popValue(),u=e.popValue();if(!l.isObjectContainer(c))throw i.UnexpectedValueType("Expected object-container type in QUEUEACTIONFOROBJECTSIN call.");if(!l.isAction(u))throw i.UnexpectedValueType("Expected action type in QUEUEACTIONFOROBJECTSIN call.");let p=e.moduleContext,d=p.resolveAction(l.asString(u));if(d.type!=r.ActionType.TRANSITIVE&&d.type!=r.ActionType.DITRANSITIVE)throw i.UnexpectedValueType("BAD TYPE: "+d.identity+" is not a transitive nor ditransitive action.");let T=p.resolveElement(l.asString(c));n.each(p.getObjectsOwnedByElement(T.identity),function(n){let a=p.resolveElement(n),i=s.createObject(d,a);e.addCommand(i),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+i.toString())})}},{name:"QUEUEACTIONFORTAGGEDOBJECTSIN",internal:!0,doOperation:function(e,t,a,o){let c=e.popValue(),u=e.popValue(),p=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in QUEUEACTIONFORTAGGEDOBJECTSIN call.");if(!l.isObjectContainer(u))throw i.UnexpectedValueType("Expected object-container type in QUEUEACTIONFORTAGGEDOBJECTSIN call.");if(!l.isAction(p))throw i.UnexpectedValueType("Expected action type in QUEUEACTIONFORTAGGEDOBJECTSIN call.");let d=e.moduleContext,T=d.resolveAction(l.asString(p));if(T.type!=r.ActionType.TRANSITIVE&&T.type!=r.ActionType.DITRANSITIVE)throw i.UnexpectedValueType("BAD TYPE: "+T.identity+" is not a transitive nor ditransitive action.");let E=l.asString(c),m=d.resolveElement(l.asString(u));n.each(d.getObjectsOwnedByElement(m.identity),function(n){if(!d.checkObjectHasTag(n,E))return;let a=d.resolveElement(n),i=s.createObject(T,a);e.addCommand(i),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+i.toString())})}},{name:"QUEUEACTIONOBJECT2",internal:!0,doOperation:function(e,t,n,a){let o=e.popValue(),c=e.popValue(),u=e.popValue();if(!l.isObject(o))throw i.UnexpectedValueType("Expected literal type in QUEUEACTIONOBJECT2 call.");if(!l.isObject(c))throw i.UnexpectedValueType("Expected literal type in QUEUEACTIONOBJECT2 call.");if(!l.isAction(u))throw i.UnexpectedValueType("Expected action type in QUEUEACTIONOBJECT2 call.");let p=e.moduleContext,d=p.resolveAction(l.asString(u)),T=p.resolveElement(l.asString(c)),E=p.resolveElement(l.asString(o));if(d.type!=r.ActionType.DITRANSITIVE)throw i.UnexpectedValueType("BAD TYPE: "+d.identity+" is not a ditransitive action.");let m=s.createObject2(d,T,E);e.addCommand(m),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+m.toString())}},{name:"ADDCUE",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ADDCUE call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in ADDCUE call.");t.addCue(l.asString(o),l.asString(r))}},{name:"TEXT",doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in TEXT call.");t.addCue(r.Cue.TEXT,l.asString(o))}},{name:"TEXTLN",doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in TEXTLN call.");t.addCue(r.Cue.TEXT,l.asString(o)+"\n")}},{name:"TEXTF",doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in TEXTF call.");t.addCue(r.Cue.TEXTF,l.asString(o))}},{name:"TEXTFLN",doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in TEXTFLN call.");t.addCue(r.Cue.TEXTF,l.asString(o)+"\n")}},{name:"PAUSE",doOperation:function(e,t,n,a){t.addCue(r.Cue.PAUSE)}},{name:"WAIT",doOperation:function(e,t,n,a){let o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in WAIT call.");t.addCue(r.Cue.WAIT,l.asLong(o))}},{name:"ASBOOLEAN",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ASBOOLEAN call.");e.pushValue(l.createBoolean(l.asBoolean(r)))}},{name:"ASINT",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ASINT call.");e.pushValue(l.createInteger(l.asLong(r)))}},{name:"ASFLOAT",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ASFLOAT call.");e.pushValue(l.createFloat(l.asDouble(r)))}},{name:"ASSTRING",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ASSTRING call.");e.pushValue(l.createString(l.asString(r)))}},{name:"ASLIST",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ASLIST call.");if(l.isList(r))e.pushValue(r);else{let t=l.createList([]);l.listAdd(t,r),e.pushValue(t)}}},{name:"LENGTH",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LENGTH call.");e.pushValue(l.createInteger(l.length(r)))}},{name:"EMPTY",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in EMPTY call.");e.pushValue(l.createBoolean(l.isEmpty(r)))}},{name:"STRCONCAT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRCONCAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRCONCAT call.");e.pushValue(l.createString(l.asString(o)+l.asString(r)))}},{name:"STRREPLACE",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in STRREPLACE call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRREPLACE call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRREPLACE call.");let u=l.asString(r),s=l.asString(o),p=l.asString(c),d=p.indexOf(s);d>=0?e.pushValue(l.createString(p.substring(0,d)+u+p.substring(d+s.length,p.length))):e.pushValue(l.createString(p))}},{name:"STRREPLACELAST",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in STRREPLACELAST call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRREPLACELAST call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRREPLACELAST call.");let u=l.asString(r),s=l.asString(o),p=l.asString(c),d=p.lastIndexOf(s);d>=0?e.pushValue(l.createString(p.substring(0,d)+u+p.substring(d+s.length,p.length))):e.pushValue(l.createString(p))}},{name:"STRREPLACEALL",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in STRREPLACEALL call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRREPLACEALL call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRREPLACEALL call.");let u=l.asString(r),s=l.asString(o),p=l.asString(c);for(;p.indexOf(s)>=0;)p=p.replace(s,u);e.pushValue(l.createString(p))}},{name:"STRINDEX",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRINDEX call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRINDEX call.");let c=l.asString(r),u=l.asString(o);e.pushValue(l.createInteger(u.indexOf(c)))}},{name:"STRLASTINDEX",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRLASTINDEX call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRLASTINDEX call.");let c=l.asString(r),u=l.asString(o);e.pushValue(l.createInteger(u.lastIndexOf(c)))}},{name:"STRCONTAINS",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRCONTAINS call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRCONTAINS call.");let c=l.asString(r),u=l.asString(o);e.pushValue(l.createBoolean(u.indexOf(c)>=0))}},{name:"STRSPLIT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRSPLIT call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRSPLIT call.");let c=l.asString(r),u=l.asString(o),s=l.createList([]),p=u.indexOf(c);for(;p>=0;)l.listAdd(s,l.createString(u.substring(0,p))),p=(u=u.substring(p+c.length,u.length)).indexOf(c);l.listAdd(s,l.createString(u)),e.pushValue(s)}},{name:"STRJOIN",doOperation:function(e,t,n,r){let o=e.popValue(),c=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRJOIN call.");if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in STRJOIN call.");let u=l.asString(o);if(l.isList(c)&&1!=l.length(c)){let t=new a,n=l.length(c);for(let e=0;e<n;e++)t.append(l.asString(l.listGet(c,e))),e<n-1&&t.append(u);e.pushValue(l.createString(t.toString()))}else e.pushValue(l.createString(l.asString(c)))}},{name:"STRSTARTSWITH",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRSTARTSWITH call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRSTARTSWITH call.");let c=l.asString(r),u=l.asString(o);e.pushValue(l.createBoolean(u.substring(0,c.length)===c))}},{name:"STRENDSWITH",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRENDSWITH call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRENDSWITH call.");let c=l.asString(r),u=l.asString(o);e.pushValue(l.createBoolean(u.substring(u.length-c.length)===c))}},{name:"SUBSTRING",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in SUBSTRING call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in SUBSTRING call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in SUBSTRING call.");let u=l.asLong(r),s=l.asLong(o),p=l.asString(c);s=Math.min(Math.max(s,0),p.length),(u=Math.min(Math.max(u,0),p.length))<=s?e.pushValue(l.createString("")):e.pushValue(l.createString(p.substring(s,u)))}},{name:"STRLOWER",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRLOWER call.");e.pushValue(l.createString(l.asString(r).toLowerCase()))}},{name:"STRUPPER",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRUPPER call.");e.pushValue(l.createString(l.asString(r).toUpperCase()))}},{name:"STRCHAR",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRCHAR call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRCHAR call.");let c=l.asLong(r),u=l.asString(o);c<0||c>=u.length?e.pushValue(l.createString("")):e.pushValue(l.createString(u.charAt(c)))}},{name:"STRTRIM",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRTRIM call.");e.pushValue(l.createString(l.asString(r).trim()))}},{name:"STRFORMAT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in STRFORMAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in STRFORMAT call.");if(!l.isList(r)){let e=l.createList([]);l.listAdd(e,r),r=e}let c="",u="",s=l.asString(o);let p="0".codePointAt(0),d="9".codePointAt(0),T=0,E=0;for(let e=0;e<s.length;e++){let t=s.charAt(e);switch(T){case 0:"["===t?(T=1,E=0,u="["):c+=t;break;case 1:"]"===t?(T=0,c+=l.asString(l.listGet(r,E))):t.codePointAt(0)>=p&&t.codePointAt(0)<=d?(E=10*E+(t.codePointAt(0)-p),u+=t):(c+=u+=t,T=0)}}e.pushValue(l.createString(c))}},{name:"ISREGEX",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ISREGEX call.");try{new RegExp(l.asString(r)),e.pushValue(l.createBoolean(!0))}catch(t){e.pushValue(l.createBoolean(!1))}}},{name:"REGEXCONTAINS",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXCONTAINS call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXCONTAINS call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r);c.test(u);e.pushValue(l.createBoolean(c.test(u)))}},{name:"REGEXFIND",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXFIND call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXFIND call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=c.exec(u);s?e.pushValue(l.createInteger(s.index)):e.pushValue(l.createInteger(-1))}},{name:"REGEXFINDLAST",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXFINDLAST call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXFINDLAST call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=null,p=-1;for(;s=c.exec(u);)p=s.index;e.pushValue(l.createInteger(p))}},{name:"REGEXGET",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXGET call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXGET call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=c.exec(u);s?e.pushValue(l.createString(s[0])):e.pushValue(l.createBoolean(!1))}},{name:"REGEXGETLAST",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXGETLAST call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXGETLAST call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=null,p=null;for(;s=c.exec(u);)p=s[0];null!==p?e.pushValue(l.createString(p)):e.pushValue(l.createBoolean(!1))}},{name:"REGEXGETALL",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXGETALL call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXGETALL call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=l.createList([]);for(;result=c.exec(u);)l.listAdd(s,l.createString(result[0]));e.pushValue(s)}},{name:"REGEXMATCHES",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXMATCHES call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXMATCHES call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.asString(r),s=c.exec(u);s?e.pushValue(l.createBoolean(u===s[0])):e.pushValue(l.createBoolean(!1))}},{name:"REGEXSPLIT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REGEXSPLIT call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REGEXSPLIT call.");let c=null;try{c=new RegExp(l.asString(o),"g")}catch(e){throw i.BadParameter("RegEx could not be compiled:\n"+e.message)}let u=l.createList([]),s=l.asString(r).split(c);for(let e=0;e<s.length;e++)l.listAdd(u,l.createString(s[e]));e.pushValue(u)}},{name:"LISTNEW",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTNEW call.");let o=l.asLong(r);o<0&&(o=0);let c=l.createList([]);for(;o-- >0;)l.listAdd(c,l.createBoolean(!1));e.pushValue(c)}},{name:"LISTADD",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTADD call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTADD call.");e.pushValue(l.createBoolean(l.listAdd(o,r)))}},{name:"LISTADDAT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTADDAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTADDAT call.");if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in LISTADDAT call.");e.pushValue(l.createBoolean(l.listAddAt(c,l.asLong(r),o)))}},{name:"LISTREMOVE",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTREMOVE call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTREMOVE call.");e.pushValue(l.createBoolean(l.listRemove(o,r)))}},{name:"LISTREMOVEAT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTREMOVEAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTREMOVEAT call.");e.pushValue(l.listRemoveAt(o,l.asLong(r)))}},{name:"LISTCONCAT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTCONCAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTCONCAT call.");if(!l.isList(o)){let e=o;o=l.createList([]),l.listAdd(o,e)}if(!l.isList(r)){let e=r;r=l.createList([]),l.listAdd(r,e)}let c=l.createList([]);for(let e=0;e<l.length(o);e++)l.listAdd(c,l.listGet(o,e));for(let e=0;e<l.length(r);e++)l.listAdd(c,l.listGet(r,e));e.pushValue(c)}},{name:"LISTINDEX",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTINDEX call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTINDEX call.");e.pushValue(l.createInteger(l.listIndexOf(o,r)))}},{name:"LISTCONTAINS",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in LISTCONTAINS call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in LISTCONTAINS call.");e.pushValue(l.createBoolean(l.listContains(o,r)))}},{name:"FLOOR",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in FLOOR call.");e.pushValue(l.createFloat(Math.floor(l.asDouble(r))))}},{name:"CEILING",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in CEILING call.");e.pushValue(l.createFloat(Math.ceil(l.asDouble(r))))}},{name:"ROUND",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ROUND call.");e.pushValue(l.createFloat(Math.round(l.asDouble(r))))}},{name:"FIX",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in FIX call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in FIX call.");let c=l.asDouble(o),u=l.asDouble(r),s=Math.pow(10,u);e.pushValue(l.createFloat(Math.round(c*s)/s))}},{name:"SQRT",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in SQRT call.");e.pushValue(l.createFloat(Math.sqrt(l.asDouble(r))))}},{name:"PI",doOperation:function(e,t,n,a){e.pushValue(l.createFloat(Math.PI))}},{name:"E",doOperation:function(e,t,n,a){e.pushValue(l.createFloat(Math.E))}},{name:"SIN",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in SIN call.");e.pushValue(l.createFloat(Math.sin(l.asDouble(r))))}},{name:"COS",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in COS call.");e.pushValue(l.createFloat(Math.cos(l.asDouble(r))))}},{name:"TAN",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in TAN call.");e.pushValue(l.createFloat(Math.tan(l.asDouble(r))))}},{name:"MIN",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in MIN call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in MIN call.");e.pushValue(l.compare(o,r)<=0?o:r)}},{name:"MAX",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in MAX call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in MAX call.");e.pushValue(l.compare(o,r)>0?o:r)}},{name:"CLAMP",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in CLAMP call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in CLAMP call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in CLAMP call.");let u=l.asDouble(r),s=l.asDouble(o),p=l.asDouble(c);e.pushValue(l.createFloat(Math.min(Math.max(p,s),u)))}},{name:"IRANDOM",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in IRANDOM call.");let o=l.asLong(r);0===o?e.pushValue(l.createInteger(0)):o<0?e.pushValue(l.createInteger(-Math.floor(Math.random()*Math.abs(o)))):e.pushValue(l.createInteger(Math.floor(Math.random()*Math.abs(o))))}},{name:"FRANDOM",doOperation:function(e,t,n,a){e.pushValue(l.createFloat(Math.random()))}},{name:"GRANDOM",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in GRANDOM call.");if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in GRANDOM call.");let c=l.asDouble(r),u=l.asDouble(o),s=1-Math.random(),p=1-Math.random(),d=u+c*(Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*p));e.pushValue(l.createFloat(d))}},{name:"TIME",doOperation:function(e,t,n,a){e.pushValue(l.createInteger(Date.now()))}},{name:"TIMEFORMAT",doOperation:function(e,t,a,r){let o=e.popValue(),c=e.popValue();if(!l.isLiteral(c))throw i.UnexpectedValueType("Expected literal type in TIMEFORMAT call.");if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in TIMEFORMAT call.");let u=l.asLong(c),s=l.asString(o);e.pushValue(l.createString(n.formatDate(u,s)))}},{name:"OBJECTHASNAME",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in OBJECTHASNAME call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in OBJECTHASNAME call.");e.pushValue(l.createBoolean(e.moduleContext.checkObjectHasName(l.asString(o),l.asString(r))))}},{name:"OBJECTHASTAG",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in OBJECTHASTAG call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in OBJECTHASTAG call.");e.pushValue(l.createBoolean(e.moduleContext.checkObjectHasTag(l.asString(o),l.asString(r))))}},{name:"ADDOBJECTNAME",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ADDOBJECTNAME call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in ADDOBJECTNAME call.");e.moduleContext.addObjectName(l.asString(o),l.asString(r))}},{name:"ADDOBJECTTAG",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in ADDOBJECTTAG call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in ADDOBJECTTAG call.");e.moduleContext.addObjectTag(l.asString(o),l.asString(r))}},{name:"ADDOBJECTTAGTOALLIN",doOperation:function(e,t,a,r){let o=e.popValue(),c=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in ADDOBJECTTAGTOALLIN call.");if(!l.isObjectContainer(c))throw i.UnexpectedValueType("Expected object-container type in ADDOBJECTTAGTOALLIN call.");let u=e.moduleContext,s=u.resolveElement(l.asString(c)),p=l.asString(o);n.each(u.getObjectsOwnedByElement(s.identity),function(e){u.addObjectTag(e,p)})}},{name:"REMOVEOBJECTNAME",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REMOVEOBJECTNAME call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in REMOVEOBJECTNAME call.");e.moduleContext.removeObjectName(l.asString(o),l.asString(r))}},{name:"REMOVEOBJECTTAG",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in REMOVEOBJECTTAG call.");if(!l.isObject(o))throw i.UnexpectedValueType("Expected object type in REMOVEOBJECTTAG call.");e.moduleContext.removeObjectTag(l.asString(o),l.asString(r))}},{name:"REMOVEOBJECTTAGFROMALLIN",doOperation:function(e,t,a,r){let o=e.popValue(),c=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in REMOVEOBJECTTAGFROMALLIN call.");if(!l.isObjectContainer(c))throw i.UnexpectedValueType("Expected object-container type in REMOVEOBJECTTAGFROMALLIN call.");let u=e.moduleContext,s=u.resolveElement(l.asString(c)),p=l.asString(o);n.each(u.getObjectsOwnedByElement(s.identity),function(e){u.removeObjectTag(e,p)})}},{name:"GIVEOBJECT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isObject(r))throw i.UnexpectedValueType("Expected object type in GIVEOBJECT call.");if(!l.isObjectContainer(o))throw i.UnexpectedValueType("Expected object-container type in GIVEOBJECT call.");let c=e.moduleContext.resolveElement(l.asString(o));e.moduleContext.addObjectToElement(c.identity,l.asString(r))}},{name:"REMOVEOBJECT",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isObject(r))throw i.UnexpectedValueType("Expected object type in REMOVEOBJECT call.");e.moduleContext.removeObject(l.asString(r))}},{name:"MOVEOBJECTSWITHTAG",doOperation:function(e,t,a,r){let o=e.popValue(),c=e.popValue(),u=e.popValue();if(!l.isLiteral(o))throw i.UnexpectedValueType("Expected literal type in MOVEOBJECTSWITHTAG call.");if(!l.isObjectContainer(c))throw i.UnexpectedValueType("Expected object-container type in MOVEOBJECTSWITHTAG call.");if(!l.isObjectContainer(u))throw i.UnexpectedValueType("Expected object-container type in MOVEOBJECTSWITHTAG call.");let s=e.moduleContext,p=s.resolveElement(l.asString(c)),d=s.resolveElement(l.asString(u)),T=l.asString(o);n.each(s.getObjectsOwnedByElement(d.identity),function(e){s.checkObjectHasTag(e,T)&&s.addObjectToElement(p.identity,e)})}},{name:"OBJECTCOUNT",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isObjectContainer(r))throw i.UnexpectedValueType("Expected object-container type in OBJECTCOUNT call.");let o=e.moduleContext.resolveElement(l.asString(r));e.pushValue(l.createInteger(e.moduleContext.getObjectsOwnedByElementCount(o.identity)))}},{name:"HASOBJECT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isObject(r))throw i.UnexpectedValueType("Expected object type in HASOBJECT call.");if(!l.isObjectContainer(o))throw i.UnexpectedValueType("Expected object-container type in HASOBJECT call.");let c=e.moduleContext.resolveElement(l.asString(o));e.pushValue(l.createBoolean(e.moduleContext.checkElementHasObject(c.identity,l.asString(r))))}},{name:"OBJECTHASNOOWNER",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isObject(r))throw i.UnexpectedValueType("Expected object type in OBJECTHASNOOWNER call.");e.pushValue(l.createBoolean(e.moduleContext.checkObjectHasNoOwner(l.asString(r))))}},{name:"PLAYERISINROOM",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isRoom(r))throw i.UnexpectedValueType("Expected room type in PLAYERISINROOM call.");if(!l.isPlayer(o))throw i.UnexpectedValueType("Expected player type in PLAYERISINROOM call.");let c=e.moduleContext,u=c.resolveElement(l.asString(r)),s=c.resolveElement(l.asString(o));e.pushValue(l.createBoolean(c.checkPlayerIsInRoom(s.identity,u.identity)))}},{name:"PLAYERCANACCESSOBJECT",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isObject(r))throw i.UnexpectedValueType("Expected object type in PLAYERCANACCESSOBJECT call.");if(!l.isPlayer(o))throw i.UnexpectedValueType("Expected player type in PLAYERCANACCESSOBJECT call.");let c=e.moduleContext.resolveElement(l.asString(o));e.pushValue(l.createBoolean(m.checkObjectAccessibility(e,t,c.identity,l.asString(r))))}},{name:"BROWSE",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isObjectContainer(r))throw i.UnexpectedValueType("Expected object-container type in BROWSE call.");let o=e.moduleContext.resolveElement(l.asString(r));m.doBrowse(e,t,o.identity)}},{name:"BROWSETAGGED",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in BROWSETAGGED call.");if(!l.isObjectContainer(o))throw i.UnexpectedValueType("Expected object-container type in BROWSETAGGED call.");let c=l.asString(r),u=e.moduleContext.resolveElement(l.asString(o));m.doBrowse(e,t,u.identity,c)}},{name:"ELEMENTHASANCESTOR",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isElement(o))throw i.UnexpectedValueType("Expected element type in ELEMENTHASANCESTOR call.");if(!l.isElement(r))throw i.UnexpectedValueType("Expected element type in ELEMENTHASANCESTOR call.");let c=e.moduleContext,u=c.resolveElement(l.asString(r)).identity,s=c.resolveElement(l.asString(o)),p=!1;for(;s;){if(s.identity==u){p=!0;break}s=s.parent?c.resolveElement(s.parent):null}e.pushValue(l.createBoolean(p))}},{name:"SETPLAYER",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isPlayer(r))throw i.UnexpectedValueType("Expected player type in SETPLAYER call.");let o=e.moduleContext.resolveElement(l.asString(r));m.doPlayerSwitch(e,t,o.identity)}},{name:"SETROOM",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isRoom(r))throw i.UnexpectedValueType("Expected room type in SETROOM call.");if(!l.isPlayer(o))throw i.UnexpectedValueType("Expected player type in SETROOM call.");let c=e.moduleContext,u=c.resolveElement(l.asString(r)),s=c.resolveElement(l.asString(o));m.doRoomSwitch(e,t,s.identity,u.identity)}},{name:"PUSHROOM",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isRoom(r))throw i.UnexpectedValueType("Expected room type in PUSHROOM call.");if(!l.isPlayer(o))throw i.UnexpectedValueType("Expected player type in PUSHROOM call.");let c=e.moduleContext,u=c.resolveElement(l.asString(r)),s=c.resolveElement(l.asString(o));m.doRoomPush(e,t,s.identity,u.identity)}},{name:"POPROOM",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isPlayer(r))throw i.UnexpectedValueType("Expected player type in POPROOM call.");let c=e.moduleContext,u=c.resolveElement(l.asString(r));if(null===c.getCurrentRoom(u.identity))throw o.Error("No rooms for player"+m.elementToString(u));m.doRoomPop(e,t,u.identity)}},{name:"SWAPROOM",doOperation:function(e,t,n,a){let r=e.popValue(),c=e.popValue();if(!l.isRoom(r))throw i.UnexpectedValueType("Expected room type in SWAPROOM call.");if(!l.isPlayer(c))throw i.UnexpectedValueType("Expected player type in SWAPROOM call.");let u=e.moduleContext,s=u.resolveElement(l.asString(c));if(null===s)throw o.Error("No current player!");let p=u.resolveElement(l.asString(r));if(null===u.getCurrentRoom(s.identity))throw new ErrorInterrupt("No rooms for current player!");m.doRoomPop(e,t,s.identity),m.doRoomPush(e,t,s.identity,p.identity)}},{name:"CURRENTPLAYERIS",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isPlayer(r))throw i.UnexpectedValueType("Expected player type in CURRENTPLAYERIS call.");let o=e.moduleContext,c=o.resolveElement(l.asString(r)),u=o.getCurrentPlayer();e.pushValue(l.createBoolean(null!==u&&c.identity===u.identity))}},{name:"NOCURRENTPLAYER",doOperation:function(e,t,n,a){let r=e.moduleContext.getCurrentPlayer();e.pushValue(l.createBoolean(null===r))}},{name:"CURRENTROOMIS",doOperation:function(e,t,n,a){let r=e.popValue(),o=e.popValue();if(!l.isPlayer(o))throw i.UnexpectedValueType("Expected player type in CURRENTROOMIS call.");if(!l.isRoom(r))throw i.UnexpectedValueType("Expected room type in CURRENTROOMIS call.");let c=e.moduleContext,u=l.asString(o),s=c.resolveElement(u),p=c.resolveElement(l.asString(r)),d=c.getCurrentRoom(s.identity);e.pushValue(l.createBoolean(null!==d&&p.identity===d.identity))}},{name:"NOCURRENTROOM",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isPlayer(r))throw i.UnexpectedValueType("Expected player type in NOCURRENTROOM call.");let o=e.moduleContext,c=l.asString(r),u=o.resolveElement(c),s=o.getCurrentRoom(u.identity);e.pushValue(l.createBoolean(null===s))}},{name:"IDENTITY",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isElement(r))throw i.UnexpectedValueType("Expected element type in IDENTITY call.");let o=e.moduleContext.resolveElement(l.asString(r));e.pushValue(l.createString(o.identity))}},{name:"HEADER",doOperation:function(e,t,n,a){let r=e.popValue();if(!l.isLiteral(r))throw i.UnexpectedValueType("Expected literal type in HEADER call.");let o=e.moduleContext.module.header[l.asString(r)];void 0===o||null===o?e.pushValue(l.createBoolean(!1)):e.pushValue(l.createString(o))}}];m.setValue=function(e,t,n){e[t=t.toLowerCase()]=n},m.getValue=function(e,t){return e[t=t.toLowerCase()]?e[t]:l.createBoolean(!1)},m.containsValue=function(e,t){return!!e[t=t.toLowerCase()]},m.clearValue=function(e,t){delete e[t=t.toLowerCase()]},m.operationToString=function(e){var t=new a;return t.append(y[e.opcode].name),e.operand0&&t.append(" ").append(l.toString(e.operand0)),e.operand1&&t.append(" ").append(l.toString(e.operand1)),t.toString()},m.elementToString=function(e){return e.tameType+"["+e.identity+"]"},m.executeBlock=function(e,t,a,i){n.each(e,function(e){y[e.opcode].internal?a.trace(t,r.TraceType.INTERNAL,n.format("CALL {0}",m.operationToString(e))):a.trace(t,r.TraceType.FUNCTION,n.format("CALL {0}",m.operationToString(e))),m.executeOperation(t,a,i,e)})},m.executeOperation=function(e,t,n,a){y[a.opcode].doOperation(e,t,n,a),t.incrementAndCheckOperationsExecuted(e.moduleContext.operationRunawayMax)},m.callConditional=function(e,t,a,o,c){let u=c.conditionalBlock;if(!u)throw i.ModuleExecution("Conditional block for "+e+" does NOT EXIST!");a.trace(t,r.TraceType.CONTROL,e+" Conditional"),m.executeBlock(u,t,a,o);let s=t.popValue();if(!l.isLiteral(s))throw i.UnexpectedValueType("Expected literal type after "+e+" conditional block execution.");let p=l.asBoolean(s);return a.trace(t,r.TraceType.CONTROL,n.format(e+" Conditional {0} is {1}",l.toString(s),p)),p},m.enqueueInterpretedAction=function(e,t,a){var i=a.action;if(null===i)return t.trace(e,r.TraceType.INTERPRETER,"UNKNOWN ACTION"),m.callUnknownCommand(e,t)||t.addCue(r.Cue.ERROR,"UNKNOWN COMMAND (make a better in-universe handler!)."),!1;switch(i.type){default:case r.ActionType.GENERAL:if(i.strict&&a.tokenOffset<a.tokens.length)return t.trace(e,r.TraceType.INTERPRETER,n.format("STRICT GENERAL ACTION {0}: Extra Tokens (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;{let n=s.create(i);return e.addCommand(n),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+n.toString()),!0}case r.ActionType.OPEN:if(a.targetLookedUp){let n=s.createModal(i,a.target);return e.addCommand(n),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+n.toString()),!0}return t.trace(e,r.TraceType.INTERPRETER,n.format("OPEN ACTION {0}: No Target (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1;case r.ActionType.MODAL:if(a.modeLookedUp){if(null===a.mode)return t.trace(e,r.TraceType.INTERPRETER,n.format("MODAL ACTION {0}: Unknown Mode (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;if(i.strict&&a.tokenOffset<a.tokens.length)return t.trace(e,r.TraceType.INTERPRETER,n.format("STRICT MODAL ACTION {0}: Extra Tokens (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;{let n=s.createModal(i,a.mode);return e.addCommand(n),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+n.toString()),!0}}return t.trace(e,r.TraceType.INTERPRETER,n.format("MODAL ACTION {0}: No Mode (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1;case r.ActionType.TRANSITIVE:if(a.objectAmbiguous)return t.trace(e,r.TraceType.INTERPRETER,n.format("TRANSITIVE ACTION {0} (AMBIGUOUS)",i.identity)),m.callAmbiguousCommand(e,t,i)||t.addCue(r.Cue.ERROR,"AMBIGUOUS COMMAND (make a better in-universe handler!)."),!1;if(a.object1LookedUp){if(null===a.object1)return t.trace(e,r.TraceType.INTERPRETER,n.format("TRANSITIVE ACTION {0}: Unknown Object (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;if(i.strict&&a.tokenOffset<a.tokens.length)return t.trace(e,r.TraceType.INTERPRETER,n.format("STRICT TRANSITIVE ACTION {0}: Extra Tokens (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;{let n=s.createObject(i,a.object1);return e.addCommand(n),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+n.toString()),!0}}return t.trace(e,r.TraceType.INTERPRETER,n.format("TRANSITIVE ACTION {0}: No Object (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1;case r.ActionType.DITRANSITIVE:if(a.objectAmbiguous)return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0} (AMBIGUOUS)",i.identity)),m.callAmbiguousCommand(e,t,i)||t.addCue(r.Cue.ERROR,"AMBIGUOUS COMMAND (make a better in-universe handler!)."),!1;if(a.object1LookedUp){if(null===a.object1)return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: Unknown First Object (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;if(a.conjugateLookedUp){if(a.conjugateFound){if(a.object2LookedUp){if(null===a.object2)return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: Unknown Second Object (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;if(i.strict&&a.tokenOffset<a.tokens.length)return t.trace(e,r.TraceType.INTERPRETER,n.format("STRICT DITRANSITIVE ACTION {0}: Extra Tokens (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1;{let n=s.createObject2(i,a.object1,a.object2);return e.addCommand(n),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+n.toString()),!0}}return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: No Second Object (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1}return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: Unknown Conjunction (MALFORMED)",i.identity)),m.callMalformedCommand(e,t,i)||t.addCue(r.Cue.ERROR,"MALFORMED COMMAND (make a better in-universe handler!)."),!1}if(i.strict)return t.trace(e,r.TraceType.INTERPRETER,n.format("STRICT DITRANSITIVE ACTION {0}: No Conjunction (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1;{t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: No Conjunction, Process TRANSITIVE",i.identity));let o=s.createObject(i,a.object1);return e.addCommand(o),t.trace(e,r.TraceType.CONTROL,"Enqueue command "+o.toString()),!0}}return t.trace(e,r.TraceType.INTERPRETER,n.format("DITRANSITIVE ACTION {0}: No First Object (INCOMPLETE)",i.identity)),m.callIncompleteCommand(e,t,i)||t.addCue(r.Cue.ERROR,"INCOMPLETE COMMAND (make a better in-universe handler!)."),!1}},m.processCommand=function(e,t,n){try{switch(n.action.type){default:case r.ActionType.GENERAL:m.doActionGeneral(e,t,n.action);break;case r.ActionType.OPEN:m.doActionOpen(e,t,n.action,n.target);break;case r.ActionType.MODAL:m.doActionModal(e,t,n.action,n.target);break;case r.ActionType.TRANSITIVE:m.doActionTransitive(e,t,n.action,n.object1);break;case r.ActionType.DITRANSITIVE:null===n.object2?m.doActionTransitive(e,t,n.action,n.object1):m.doActionDitransitive(e,t,n.action,n.object1,n.object2)}}catch(e){if(!(e instanceof o)||e.type!=o.Type.Finish)throw e}e.checkStackClear()},m.doAllCommands=function(e,t){for(;e.hasCommands();)m.processCommand(e,t,e.nextCommand())},m.processCommandLoop=function(e,t,n,a,r){m.doAllCommands(e,t);let i=e.moduleContext.getElementContext("world");n&&(m.callElementBlock(e,t,i,"AFTERSUCCESSFULCOMMAND"),m.doAllCommands(e,t)),a&&(m.callElementBlock(e,t,i,"AFTERFAILEDCOMMAND"),m.doAllCommands(e,t)),r&&(m.callElementBlock(e,t,i,"AFTEREVERYCOMMAND"),m.doAllCommands(e,t))},m.createTracingMap=function(e){let t={};if(!0===e)t=r.TraceType.ALL;else if(n.isArray(e)){t={};for(let n=0;n<e.length;n++)t[e[n].toString().toLowerCase()]=!0}else n.isObject(e)&&(t={},n.each(e,function(e,n){let a=n.toLowerCase();t[a]=!0}));return t},m.tokenizeInput=function(e,t){return t.trim().toLowerCase().split(/\s+/)},m.handleInit=function(e,t){let a=m.createTracingMap(t),l=new c(e,"[INITIALIZE]",a),s=new u;s.interpretNanos=0;let p=n.nanoTime();try{m.initializeContext(l,s),m.processCommandLoop(l,s,!1,!1,!1)}catch(e){e instanceof o?e.type!=o.Type.Quit&&s.addCue(r.Cue.ERROR,e.type+" interrupt was thrown."):e instanceof i?s.addCue(r.Cue.FATAL,e.message):s.addCue(r.Cue.FATAL,e)}return s.requestNanos=n.nanoTime()-p,s},m.handleRequest=function(e,t,a){let l=m.createTracingMap(a),s=new c(e,t,l),p=new u,d=n.nanoTime(),T=m.interpret(s,p);p.interpretNanos=n.nanoTime()-d,d=n.nanoTime();try{let e=m.enqueueInterpretedAction(s,p,T);m.processCommandLoop(s,p,e,!e,!0)}catch(e){e instanceof o?e.type!=o.Type.Quit&&p.addCue(r.Cue.ERROR,e.type+" interrupt was thrown."):e instanceof i?p.addCue(r.Cue.FATAL,e.message):p.addCue(r.Cue.FATAL,e)}return p.requestNanos=n.nanoTime()-d,p},m.inspect=function(e,t,a){let r={},i=e.getElementContext(t);return i?(a?r[i.identity+"."+a]=l.toString(m.getValue(i.variables,a)):n.each(i.variables,(e,t)=>{r[i.identity+"."+t]=l.toString(e)}),r):null},m.callBlock=function(e,t,a,i,l,c){t.trace(e,r.TraceType.CONTEXT,n.format("PUSH {0}","Context:"+a.identity)),e.pushContext(a),c||(c={});try{m.executeBlock(i,e,t,c)}catch(e){if(!(e instanceof o)||e.type!=o.Type.End)throw e}finally{t.trace(e,r.TraceType.CONTEXT,n.format("POP {0}","Context:"+a.identity)),e.popContext()}l||e.checkStackClear()},m.callElementBlock=function(e,t,a,i,o,c,u){let s=e.moduleContext,p=s.resolveBlockName(i,o);t.trace(e,r.TraceType.ENTRY,n.format("RESOLVE {0}.{1}",a.identity,p));let d=s.resolveBlock(a.identity,i,o);if(null!==d){if(t.trace(e,r.TraceType.ENTRY,n.format("CALL {0}.{1}",a.identity,p)),u&&c){u=l.createString(u);let i={};t.trace(e,r.TraceType.VALUE,n.format("SET LOCAL {0} {1}",c,l.toString(u))),m.setValue(i,c,u),m.callBlock(e,t,a,d,!1,i)}else m.callBlock(e,t,a,d);return!0}return!1},m.callElementFunction=function(e,t,a,o){var c=e.moduleContext,u=c.resolveElement(o.identity),s=c.resolveFunction(o.identity,a);if(null===s)throw i.Module("No such function ("+a+") in lineage of element "+m.elementToString(u));t.trace(e,r.TraceType.FUNCTION,"CALL "+a);for(var p={},d=s.arguments,T=d.length-1;T>=0;T--){var E=e.popValue();t.trace(e,r.TraceType.FUNCTION,n.format("SET LOCAL {0} {1}",d[T],l.toString(E))),p[d[T]]=E}return t.incrementAndCheckFunctionDepth(e.moduleContext.functionDepthMax),m.callBlock(e,t,o,s.block,!0,p),t.decrementFunctionDepth(),m.getValue(p,r.RETURN_VARIABLE)},m.interpret=function(e,t){let n=e.moduleContext;var a={tokens:m.tokenizeInput(n,e.inputMessage),tokenOffset:0,objects:[null,null],action:null,modeLookedUp:!1,mode:null,targetLookedUp:!1,target:null,conjugateLookedUp:!1,conjugate:null,object1LookedUp:!1,object1:null,object2LookedUp:!1,object2:null,objectAmbiguous:!1};m.interpretAction(e,t,a);let i=a.action;if(null===i)return a;switch(i.type){default:case r.ActionType.GENERAL:return a;case r.ActionType.OPEN:return m.interpretOpen(e,t,a),a;case r.ActionType.MODAL:return m.interpretMode(e,t,i,a),a;case r.ActionType.TRANSITIVE:return m.interpretObject1(e,t,a),a;case r.ActionType.DITRANSITIVE:return m.interpretObject1(e,t,a)&&m.interpretConjugate(e,t,i,a)&&m.interpretObject2(e,t,a),a}},m.interpretAction=function(e,t,n){for(var i=e.moduleContext.module,o=new a,l=n.tokenOffset,c=n.tokens;l<c.length;){o.length()>0&&o.append(" "),o.append(c[l]),l++;let a=o.toString();t.trace(e,r.TraceType.INTERPRETER,"TEST ACTION "+a);var u=i.getActionByName(a);null!==u&&(t.trace(e,r.TraceType.INTERPRETER,"MATCHED ACTION "+u.identity),n.action=u,n.tokenOffset=l)}},m.interpretMode=function(e,t,n,i){for(var o=new a,l=i.tokenOffset,c=i.tokens;l<c.length;){o.length()>0&&o.append(" "),o.append(c[l]),l++,i.modeLookedUp=!0;var u=o.toString();t.trace(e,r.TraceType.INTERPRETER,"TEST MODE "+u),n.extraStrings.indexOf(u)>=0&&(t.trace(e,r.TraceType.INTERPRETER,"MATCHED MODE "+u),i.mode=u,i.tokenOffset=l)}},m.interpretOpen=function(e,t,n){for(var i=new a,o=n.tokenOffset,l=n.tokens;o<l.length;)n.targetLookedUp=!0,i.length()>0&&i.append(" "),i.append(l[o]),o++;var c=i.toString();t.trace(e,r.TraceType.INTERPRETER,"READ OPEN TARGET "+c),n.target=c.length>0?c:null,n.tokenOffset=o},m.interpretConjugate=function(e,t,n,i){for(var o=new a,l=i.tokenOffset,c=i.tokens,u=!1;l<c.length;){o.length()>0&&o.append(" "),o.append(c[l]),l++,i.conjugateLookedUp=!0;let a=o.toString();t.trace(e,r.TraceType.INTERPRETER,"TEST CONJUNCTION "+a),n.extraStrings.indexOf(a)>=0&&(t.trace(e,r.TraceType.INTERPRETER,"MATCHED CONJUNCTION "+a),i.tokenOffset=l,u=!0)}return i.conjugateFound=u,u},m.interpretObject1=function(e,t,n){let i=e.moduleContext;for(var o=new a,l=n.tokenOffset,c=n.tokens;l<c.length;){o.length()>0&&o.append(" "),o.append(c[l]),l++;let a=o.toString();n.object1LookedUp=!0,t.trace(e,r.TraceType.INTERPRETER,"TEST OBJECT 1 "+a);let u=i.getAccessibleObjectsByName(a,n.objects,0);u>1?(t.trace(e,r.TraceType.INTERPRETER,"MATCHED MULTIPLE OBJECTS"),n.objectAmbiguous=!0,n.object1=null,n.tokenOffset=l):u>0&&(t.trace(e,r.TraceType.INTERPRETER,"MATCHED OBJECT 1 "+n.objects[0].identity),n.objectAmbiguous=!1,n.object1=n.objects[0],n.tokenOffset=l)}return null!==n.object1},m.interpretObject2=function(e,t,n){let i=e.moduleContext;for(var o=new a,l=n.tokenOffset,c=n.tokens;l<c.length;){o.length()>0&&o.append(" "),o.append(c[l]),l++;let a=o.toString();n.object2LookedUp=!0,t.trace(e,r.TraceType.INTERPRETER,"TEST OBJECT 2 "+a);let u=i.getAccessibleObjectsByName(a,n.objects,0);u>1?(t.trace(e,r.TraceType.INTERPRETER,"MATCHED MULTIPLE OBJECTS"),n.objectAmbiguous=!0,n.object2=null,n.tokenOffset=l):u>0&&(t.trace(e,r.TraceType.INTERPRETER,"MATCHED OBJECT 2 "+n.objects[0].identity),n.objectAmbiguous=!1,n.object2=n.objects[0],n.tokenOffset=l)}return null!==n.object2},m.checkObjectAccessibility=function(e,t,n,a){let r=e.moduleContext,i=r.getElement("world");if(r.checkElementHasObject(i.identity,a))return!0;if(r.checkElementHasObject(n,a))return!0;let o=r.getCurrentRoom(n);return!(null===o||!r.checkElementHasObject(o.identity,a))},m.doArithmeticStackFunction=function(e,t,n){if(n<0||n>=f.COUNT)throw i.ModuleExecution("Expected arithmetic function type, got illegal value "+n+".");var a=f[n];if(t.trace(e,r.TraceType.INTERNAL,"Operator is "+a.name),a.binary){let t=e.popValue(),n=e.popValue();e.pushValue(a.doOperation(n,t))}else{let t=e.popValue();e.pushValue(a.doOperation(t))}},m.doPlayerSwitch=function(e,t,n){e.moduleContext.setCurrentPlayer(n),t.trace(e,r.TraceType.CONTEXT,"CURRENT PLAYER: "+n)},m.doRoomPop=function(e,t,a){let i=e.moduleContext.popRoomFromPlayer(a);i&&t.trace(e,r.TraceType.CONTEXT,n.format("POP ROOM {0} FROM PLAYER {1}",i,a))},m.doRoomPush=function(e,t,a,i){e.moduleContext.pushRoomOntoPlayer(a,i),t.trace(e,r.TraceType.CONTEXT,n.format("PUSH ROOM {0} ON PLAYER {1}",i,a))},m.doRoomSwitch=function(e,t,n,a){for(var r=e.moduleContext;null!==r.getCurrentRoom(n);)m.doRoomPop(e,t,n);m.doRoomPush(e,t,n,a)},m.doBrowseBlockSearch=function(e,t,n,a){var r=e.moduleContext;if("TWorld"===n.tameType)return m.callElementBlock(e,t,a,"ONWORLDBROWSE");for(var o=n;null!==o;){let n,c;if("TContainer"===o.tameType)n="ONELEMENTBROWSE",c=[l.createContainer(o.identity)];else if("TRoom"===o.tameType)n="ONELEMENTBROWSE",c=[l.createRoom(o.identity)];else{if("TPlayer"!==o.tameType)throw i.UnexpectedValueType("Bad object container type in hierarchy.");n="ONELEMENTBROWSE",c=[l.createPlayer(o.identity)]}if(m.callElementBlock(e,t,a,n,c))return!0;o=o.parent?r.getElement(o.parent):null}if("TContainer"===n.tameType)return m.callElementBlock(e,t,a,"ONCONTAINERBROWSE");if("TRoom"===n.tameType)return m.callElementBlock(e,t,a,"ONROOMBROWSE");if("TPlayer"===n.tameType)return m.callElementBlock(e,t,a,"ONPLAYERBROWSE");throw i.UnexpectedValueType("Bad object container type in hierarchy.")},m.doBrowse=function(e,t,a,r){var i=e.moduleContext,o=i.resolveElement(a);n.each(i.getObjectsOwnedByElement(o.identity),function(n){var a=i.getElementContext(n);r&&!i.checkObjectHasTag(n,r)||m.doBrowseBlockSearch(e,t,o,a)})},m.callInitOnContexts=function(e,t,a){n.each(a,function(n){m.callElementBlock(e,t,n,"INIT")})},m.initializeContext=function(e,t){var a=e.moduleContext,r=[],i=[],l=[],c=[];n.each(a.state.elements,function(e){var t=a.resolveElement(e.identity);"TContainer"===t.tameType?r.push(e):"TObject"===t.tameType?i.push(e):"TPlayer"===t.tameType?c.push(e):"TRoom"===t.tameType&&l.push(e)});try{m.callInitOnContexts(e,t,r),m.callInitOnContexts(e,t,i),m.callInitOnContexts(e,t,l),m.callInitOnContexts(e,t,c);let n=a.resolveElementContext("world");m.callElementBlock(e,t,n,"INIT"),m.callElementBlock(e,t,n,"START")}catch(e){if(!(e instanceof o)||e.type!=o.Type.Finish)throw e}},m.callAmbiguousCommand=function(e,t,n){let a=e.moduleContext,r=a.getCurrentPlayerContext(),i=[l.createAction(n.identity)];if(null!==r){if(m.callElementBlock(e,t,r,"ONAMBIGUOUSCOMMAND",i))return!0;if(m.callElementBlock(e,t,r,"ONAMBIGUOUSCOMMAND"))return!0}let o=a.getElementContext("world");return!!m.callElementBlock(e,t,o,"ONAMBIGUOUSCOMMAND",i)||!!m.callElementBlock(e,t,o,"ONAMBIGUOUSCOMMAND")},m.callMalformedCommand=function(e,t,n){let a=e.moduleContext,r=a.getCurrentPlayerContext(),i=[l.createAction(n.identity)];if(null!==r){if(m.callElementBlock(e,t,r,"ONMALFORMEDCOMMAND",i))return!0;if(m.callElementBlock(e,t,r,"ONMALFORMEDCOMMAND"))return!0}let o=a.getElementContext("world");return!!m.callElementBlock(e,t,o,"ONMALFORMEDCOMMAND",i)||!!m.callElementBlock(e,t,o,"ONMALFORMEDCOMMAND")},m.callIncompleteCommand=function(e,t,n){let a=e.moduleContext,r=a.getCurrentPlayerContext(),i=[l.createAction(n.identity)];if(null!==r){if(m.callElementBlock(e,t,r,"ONINCOMPLETECOMMAND",i))return!0;if(m.callElementBlock(e,t,r,"ONINCOMPLETECOMMAND"))return!0}let o=a.getElementContext("world");return!!m.callElementBlock(e,t,o,"ONINCOMPLETECOMMAND",i)||!!m.callElementBlock(e,t,o,"ONINCOMPLETECOMMAND")},m.callActionUnhandled=function(e,t,n){var a=e.moduleContext,r=a.getCurrentPlayerContext();let i=[l.createAction(n.identity)];if(null!==r){if(m.callElementBlock(e,t,r,"ONUNHANDLEDACTION",i))return!0;if(m.callElementBlock(e,t,r,"ONUNHANDLEDACTION"))return!0}let o=a.getElementContext("world");return!!m.callElementBlock(e,t,o,"ONUNHANDLEDACTION",i)||!!m.callElementBlock(e,t,o,"ONUNHANDLEDACTION")},m.callUnknownCommand=function(e,t){let n=e.moduleContext,a=n.getCurrentPlayerContext();if(null!==a&&m.callElementBlock(e,t,a,"ONUNKNOWNCOMMAND"))return!0;let r=n.getElementContext("world");return!!m.callElementBlock(e,t,r,"ONUNKNOWNCOMMAND")},m.doActionGeneral=function(e,t,n){m.doActionOpen(e,t,n,null)},m.doActionOpen=function(e,t,n,a){let i=e.moduleContext,o=i.getCurrentPlayerContext(),c=[l.createAction(n.identity)],u=n.extraStrings?n.extraStrings[0]:null;if(null!==o){let n=i.getCurrentRoomContext();if(null!==n&&m.callElementBlock(e,t,n,"ONACTION",c,u,a))return;if(m.callElementBlock(e,t,o,"ONACTION",c,u,a))return}let s=i.getElementContext("world");m.callElementBlock(e,t,s,"ONACTION",c,u,a)||m.callActionUnhandled(e,t,n)||t.addCue(r.Cue.ERROR,"ACTION UNHANDLED (make a better in-universe handler!).")},m.doActionModal=function(e,t,n,a){let i=e.moduleContext,o=i.getCurrentPlayerContext(),c=[l.createAction(n.identity),l.createString(a)];if(null!==o){let n=i.getCurrentRoomContext();if(null!==n&&m.callElementBlock(e,t,n,"ONMODALACTION",c))return;if(m.callElementBlock(e,t,o,"ONMODALACTION",c))return}let u=i.getElementContext("world");m.callElementBlock(e,t,u,"ONMODALACTION",c)||m.callActionUnhandled(e,t,n)||t.addCue(r.Cue.ERROR,"ACTION UNHANDLED (make a better in-universe handler!).")},m.doActionTransitive=function(e,t,n,a){let i=e.moduleContext,o=i.getElementContext(a.identity),c=l.createAction(n.identity);if(m.callElementBlock(e,t,o,"ONACTION",[c]))return;let u=l.createObject(a.identity),s=i.getCurrentPlayerContext();if(null!==s){let n=i.getCurrentRoomContext();if(null!==n){if(m.callElementBlock(e,t,n,"ONACTIONWITH",[c,u]))return;if(m.doActionAncestorSearch(e,t,c,n,a))return;if(m.callElementBlock(e,t,n,"ONACTIONWITHOTHER",[c]))return}if(m.callElementBlock(e,t,s,"ONACTIONWITH",[c,u]))return;if(m.doActionAncestorSearch(e,t,c,s,a))return;if(m.callElementBlock(e,t,s,"ONACTIONWITHOTHER",[c]))return}let p=i.getElementContext("world");m.callElementBlock(e,t,p,"ONACTIONWITH",[c,u])||m.doActionAncestorSearch(e,t,c,p,a)||m.callElementBlock(e,t,p,"ONACTIONWITHOTHER",[c])||m.callActionUnhandled(e,t,n)||t.addCue(r.Cue.ERROR,"ACTION UNHANDLED (make a better in-universe handler!).")},m.doActionAncestorSearch=function(e,t,n,a,r){for(var i=e.moduleContext,o=r.parent?i.getElement(r.parent):null;null!==o;){if(m.callElementBlock(e,t,a,"ONACTIONWITHANCESTOR",[n,l.createObject(o.identity)]))return!0;o=o.parent?i.getElement(o.parent):null}return!1},m.doActionDitransitive=function(e,t,n,a,i){let o=e.moduleContext,c=o.getElementContext(a.identity),u=o.getElementContext(i.identity),s=l.createAction(n.identity),p=l.createObject(a.identity),d=l.createObject(i.identity);var T=!n.strict||!n.reversed,E=!n.strict||n.reversed;T&&m.callElementBlock(e,t,c,"ONACTIONWITH",[s,d])||E&&m.callElementBlock(e,t,u,"ONACTIONWITH",[s,p])||T&&m.doActionAncestorSearch(e,t,s,c,i)||E&&m.doActionAncestorSearch(e,t,s,u,a)||T&&m.callElementBlock(e,t,c,"ONACTIONWITHOTHER",[s])||E&&m.callElementBlock(e,t,u,"ONACTIONWITHOTHER",[s])||m.callActionUnhandled(e,t,n)||t.addCue(r.Cue.ERROR,"ACTION UNHANDLED (make a better in-universe handler!).")};var O=function(e){let t=this,a=function(){};this.defaultOptions={print:a,onStart:a,onEnd:a,onSuspend:a,onResume:a,onQuit:a,onPause:a,onError:a,onFatal:a,onTrace:a,onOtherCue:a,onStartFormatTag:a,onEndFormatTag:a,onFormatText:function(e,t){t.push(e)}},e||(e={});let r={};for(let t in this.defaultOptions)this.defaultOptions.hasOwnProperty(t)&&(r[t]=e[t]||this.defaultOptions[t]);this.options=r,this.cueHandlers={quit:function(){return t.stop=!0,!1},text:function(e){return t.textBuffer.push(e),!0},textf:function(e){return t.textBuffer.push(n.parseFormatted(e,t.options.onStartFormatTag,t.options.onEndFormatTag,t.options.onFormatText)),!0},wait:function(e){return setTimeout(function(){t.resume()},parseInt(e,10)),!1},pause:function(){return t.pause=!0,!1},error:function(e){return t.options.onError(e),!0},fatal:function(e){return t.options.onFatal(e),t.stop=!0,!1}}};return O.prototype.reset=function(){this.stop=!1,this.pause=!1,this.textBuffer=[]},O.prototype.prepare=function(e){this.reset(),this.response=e,this.nextCue=0},O.prototype.resume=function(){if(!this.response)throw new Error("resume() before prepare()!");0===this.nextCue?this.options.onStart():this.options.onResume(),this.pause&&(this.pause=!1);let e=!0;for(;this.nextCue<this.response.responseCues.length&&e;){let t=this.response.responseCues[this.nextCue++],n=t.type.toLowerCase(),a=t.content;if("text"!==n&&"textf"!==n&&(this.options.print(this.textBuffer.join("")),this.textBuffer.length=0),n.startsWith("trace-")){let e=n.substring("trace-".length);this.options.onTrace(e,a)}else e=this.cueHandlers[n]?this.cueHandlers[n](a):this.options.onOtherCue(n,a)}return this.textBuffer.length>0&&(this.options.print(this.textBuffer.join("")),this.textBuffer.length=0),this.pause&&this.options.onPause(),this.stop?(this.response=null,this.options.onQuit(),this.options.onEnd(),!1):!this.pause&&(this.nextCue<this.response.responseCues.length?(this.options.onSuspend(),!0):(this.options.onEnd(),!1))},O.prototype.process=function(e){return this.prepare(e),this.resume()},this.newResponseHandler=function(e){return new O(e)},this.readModule=function(e){return E.readModule(e)},this.newContext=function(e){return e?new d(e):null},this.initialize=function(e,t){return m.handleInit(e,t)},this.interpret=function(e,t,n){return m.handleRequest(e,t,n)},this.inspect=function(e,t,n){return m.inspect(e,t,n)},this}(this);